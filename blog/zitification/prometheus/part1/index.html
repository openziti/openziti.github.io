<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Enable Prometheus to Scrape Anything from Anywhere | OpenZiti</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://openziti.io/blog/zitification/prometheus/part1"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="index, follow"><meta data-rh="true" property="og:title" content="Enable Prometheus to Scrape Anything from Anywhere | OpenZiti"><meta data-rh="true" name="description" content="_This is part one of a three-part article. This article provides the necessary background and rationale of the series."><meta data-rh="true" property="og:description" content="_This is part one of a three-part article. This article provides the necessary background and rationale of the series."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-01-15T15:50:26.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://openziti.io/blog/zitification/prometheus/part1"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/zitification/prometheus/part1" hreflang="en"><link data-rh="true" rel="alternate" href="https://openziti.io/blog/zitification/prometheus/part1" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EXWPKK5PV4-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenZiti RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenZiti Atom Feed">


<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-5SF399H3",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>




<link rel="search" type="application/opensearchdescription+xml" title="OpenZiti" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.d43ad171.css">
<link rel="preload" href="/assets/js/runtime~main.802e1845.js" as="script">
<link rel="preload" href="/assets/js/main.9be12a4c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5SF399H3" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>



<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="root_VOM9"><span style="color:whitesmoke">Star us on GitHub </span><span style="height:20px"><span><a href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star buttons/github-buttons on GitHub">Star</a></span></span></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://openziti.io" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/ziti-logo-dark.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ziti-logo-light.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/learn/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/docs/downloads">Downloads</a><a href="https://blog.openziti.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li><div class="text-divider"><p>Socials</p></div></li><li><a href="https://www.youtube.com/OpenZiti" target="_blank" title="OpenZiti on YouTube"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/yt.svg">YouTube</span></a></li><li><a href="https://twitter.com/OpenZiti" target="_blank" title="OpenZiti on Twitter"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/twit.svg">Twitter</span></a></li><li><a href="https://www.reddit.com/r/openziti" target="_blank" title="OpenZiti Subreddit"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/reddit-logo.png">Reddit</span></a></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/ziggy.png"><a href="https://twitter.com/OpenZiggy" target="_blank" title="OpenZiggy on Twitter">Ziggy</a></span></li><li><div class="text-divider"><p>Other</p></div></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/blog-icon.png"><a href="https://blog.openziti.io/" target="_blank" title="Blog">Blog</a></span></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/oz-test-kitchen.png"><a href="https://github.com/openziti-test-kitchen" target="_blank" title="Git project for the test kitchen">Test Kitchen</a></span></li><li><a href="https://zeds.openziti.org" target="_blank" title="Developer Sandbox"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/zeds.png">ZEDS</span></a></li><li><a href="https://netfoundry.io/pricing/" target="_blank" title="NetFoundry-hosted Ziti"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/nf.svg">CloudZiti</span></a></li></ul></div><a href="https://openziti.discourse.group/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discourse-link" title="Discourse"></a><a href="https://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_eExm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/articles">Articles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/c-sdk-on-beaglebone">Building the Ziti C SDK and Sample Apps for arm (BeagleBone)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-03.certificates">Bootstrapping Trust</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="_This is part one of a three-part article. This article provides the necessary background and rationale of the series."><header><h1 class="title_f1Hy" itemprop="headline">Enable Prometheus to Scrape Anything from Anywhere</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-01-15T15:50:26.000Z" itemprop="datePublished">January 15, 2024</time> · <!-- -->13 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><em>This is part one of a three-part article. This article provides the necessary background and rationale of the series.
<a href="/blog/zitification/prometheus/part2">The next article</a> will be a detailed explanation of the actual steps necessary to implement the solution.
In <a href="/blog/zitification/prometheus/part3">the final article</a>, we will explore what we have just created and understand what was just created</em></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem-with-pulling">The Problem With Pulling<a href="#the-problem-with-pulling" class="hash-link" aria-label="Direct link to The Problem With Pulling" title="Direct link to The Problem With Pulling">​</a></h2><p>Prometheus is a server which wants to reach out and pull data from &quot;scrape targets&quot;. It will generally do this using http requests. One
problem with this design is that these targets are often inaccessible, hidden from Prometheus behind a firewall.</p><p>If not hidden, it means some port was exposed on some network, thereby giving Prometheus the ability to pull the data it needs. Exposing
that port on a &quot;trusted&quot; network is a possible attack vector for bad actors. Exposing that port on the open internet (as is often the case)
is an open invitation for attack. It&#x27;s much better to keep these servers totally dark to all networks.</p><p>OpenZiti solves this problem of reach elegantly and natively while also keeping your service dark to all networks. This gives an
OpenZiti-enabled Prometheus the ability to literally scrape any target, anywhere. As long as the target is participates on an OpenZiti
overlay network, and as long as the proper polices are in place allowing the traffic to flow, Prometheus will be able to reach out and
pull the data it needs from anything, anywhere.</p><p>It doesn&#x27;t matter if the target is in some private cloud data center, some private data center protected by a corporate firewall, or heck
even running inside my local docker environment! As long as the target participates on that OpenZiti Prometheus can scrape it! That sort of
reach is impossible with classic networks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">Prometheus<a href="#prometheus" class="hash-link" aria-label="Direct link to Prometheus" title="Direct link to Prometheus">​</a></h2><p><a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer">Prometheus</a> is an incredibly popular <a href="https://www.cncf.io/projects/prometheus/" target="_blank" rel="noopener noreferrer">CNCF</a>
project which has graduated the gauntlet of progressions to emerge as a &quot;graduated&quot; CNCF project. If you&#x27;re familiar with Prometheus, there
are probably a couple of reasons people mainly choose to deploy it:
metrics collection and visualization and alerting.</p><p>Prometheus is also tremendously flexible. It has numerous available plugins and supports integrating with a wide number of systems.
According
to <a href="https://www.cncf.io/blog/2022/03/08/cloud-native-observability-microsurvey-prometheus-leads-the-way-but-hurdles-remain-to-understanding-the-health-of-systems/" target="_blank" rel="noopener noreferrer">this CNCF survey</a>
, Prometheus leads the pack when it comes to the project people go to for observability. Its popularity is probably because Prometheus is a
CNCF project and is often considered the &quot;default&quot; solution to deploy on another wildly popular CNCF project
called <a href="https://kubernetes.io" target="_blank" rel="noopener noreferrer">Kubernetes</a>. One interesting aspect of Prometheus is that it generally favors a poll-based approach to
metrics collection instead of a push-based model.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-based">Poll-based?<a href="#poll-based" class="hash-link" aria-label="Direct link to Poll-based?" title="Direct link to Poll-based?">​</a></h3><p>I don&#x27;t know about you, but historically when I&#x27;ve thought about a metrics collection agent, I tend to think of an agent that reads a log
file or some library that pushes rows into a giant data lake in the cloud. I don&#x27;t generally think about a solution that implements
poll-based metrics. Often, this is because the target of a poll-based collecting agent will probably be behind a firewall.</p><p><img loading="lazy" alt="FW" src="/assets/images/fw-b1c8555546b90b5151f6ede0e27d7111.png" width="489" height="276" class="img_ev3q"></p><p>As you would expect, firewalls make it exceptionally difficult to implement a poll-based solution as firewalls have been known to make a
habit of preventing external actors from accessing random http servers behind it! After all, that is their primary function!</p><p>The Prometheus project makes <a href="https://prometheus.io/docs/practices/pushing/" target="_blank" rel="noopener noreferrer">strong arguments</a> explaining the benefits of a poll-based
solution. They also realize that firewalls are important in creating a safe network and understand the challenges firewalls create for such
a solution. To deal with these situations, the project also provides a <a href="https://prometheus.io/docs/instrumenting/pushing/" target="_blank" rel="noopener noreferrer">PushGateway</a>.
This allows solutions to push their data to a location outbound of the firewall. Pushing data out of the firewall allows metrics and
alerting to function without the worry (and maintenance heartache) of an open, inbound firewall hole.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="acceptable-risk">Acceptable Risk<a href="#acceptable-risk" class="hash-link" aria-label="Direct link to Acceptable Risk" title="Direct link to Acceptable Risk">​</a></h3><p>Prometheus is often deployed into Kubernetes clusters, but it can be deployed anywhere. Taking the operational differences out of the
equation, there is little difference between deploying Prometheus in a Kubernetes cluster and deploying it in one&#x27;s data center. Once
deployed, the needs will be the same. Prometheus will need to be authorized to reach out and scrape the targets it needs to scrape. All too
often, this is done with relatively open network permissions. Even though we all know it&#x27;s not the most secure way of authorizing
Prometheus, this is often considered &quot;safe enough&quot; because we deployed Prometheus into a zone considered &quot;safe&quot;. Managing firewall rules to
all the computers Prometheus needs access to, feels like an impossible feat. There are just too many.</p><p>To add to our acceptable risk, we will need to be able to access the Prometheus server in some way. We&#x27;ll want to get at the UI, see the
charts and graphs and data it provides and use the server to its fullest. For that, we&#x27;ll <strong>of course</strong>
need a hole in our firewall, or in the case of Kubernetes we will probably deploy some form of
<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress Controller</a> to provide users access
the service.</p><p>What we need are better and richer controls over our network. We need a better way of authorizing Prometheus without the hassle of
maintaining firewall rules on individual machines. We also need a way to do this across multiple clouds, multiple Kubernetes clusters and
multiple data centers. Let&#x27;s see how OpenZiti can solve this problem while also enhancing our overall security.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openziti">OpenZiti<a href="#openziti" class="hash-link" aria-label="Direct link to OpenZiti" title="Direct link to OpenZiti">​</a></h2><p>The <a href="https://openziti.github.io" target="_blank" rel="noopener noreferrer">OpenZiti</a> project allows us to solve all the problems outlined above. It is a fully-featured, zero trust
overlay network and enables <a href="https://en.wikipedia.org/wiki/Zero_trust_security_model" target="_blank" rel="noopener noreferrer">zero trust networking principles</a> to be applied
anywhere. This includes bringing those zero trust principles directly into your application through one of the many SDKs provided
by the project. Let&#x27;s look at an example and see what a setup might look like before and after applying OpenZiti.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3><p>Let&#x27;s imagine that we have already deployed a solution using two Kubernetes clusters, ClusterA and ClusterB. It doesn&#x27;t matter where the
clusters are deployed. We are trying to illustrate a real-world situation where we have two separate Kubernetes clusters that we want to
manage. The clusters could be deployed in the same cloud provider, in a private data center, in different cloud providers, it really does
not matter. What is important, is that these clusters are available over the network. To enable access to the workloads inside the
clusters, some form of Kubernetes ingress controller will be required on both clusters. In our example, we will have a workload deployed
which exposes a prometheus scrape target we want Prometheus to monitor.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="figure-1---before-openziti">Figure 1 - Before OpenZiti<a href="#figure-1---before-openziti" class="hash-link" aria-label="Direct link to Figure 1 - Before OpenZiti" title="Direct link to Figure 1 - Before OpenZiti">​</a></h4><p><img loading="lazy" alt="Before OpenZiti" src="/assets/images/kubernetes-prometheus-before-15c1791d4c7ba9b5960fa1af5bacb258.svg" width="1099" height="534" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-a-closer-look">Taking a Closer Look<a href="#taking-a-closer-look" class="hash-link" aria-label="Direct link to Taking a Closer Look" title="Direct link to Taking a Closer Look">​</a></h3><p>Looking at the diagram above with a discerning eye towards security, there are some immediate observations one can make.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="listening-ports">Listening Ports<a href="#listening-ports" class="hash-link" aria-label="Direct link to Listening Ports" title="Direct link to Listening Ports">​</a></h4><p>One observation we have already accepted from the overview, is that these clusters must be exposed via the internet. At first that doesn&#x27;t
seem like a big deal, we expose workloads like this to the internet all the time. This is a perfectly normal action, it&#x27;s likely
done every day somewhere in the world. It&#x27;s so common, we almost don&#x27;t even think about it until the time comes when we <strong>need</strong> to
think about it. This ends up in an exposed port, listening somewhere in the world. There might be a firewall with complex rules to
protect this port, but it&#x27;s just as likely that this isn&#x27;t the case. People might need to access the resources inside these clusters
from anywhere. </p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-exposed">Kubernetes API Exposed<a href="#kubernetes-api-exposed" class="hash-link" aria-label="Direct link to Kubernetes API Exposed" title="Direct link to Kubernetes API Exposed">​</a></h4><p>Another observation is that the Kubernetes API is fully exposed to the internet. This API is a very high-value target and should be
secured as strongly as possible. That probably means yet another complex firewall rule to maintain.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-intra-cluster-traffic">&quot;Trusted&quot; Intra-cluster Traffic<a href="#trusted-intra-cluster-traffic" class="hash-link" aria-label="Direct link to &quot;Trusted&quot; Intra-cluster Traffic" title="Direct link to &quot;Trusted&quot; Intra-cluster Traffic">​</a></h4><p>The final point to note is that the traffic within the cluster is considered safe. As mentioned above, the Prometheus server needs to be
able to scrape the target workloads. That traffic is necessary to be considered safe. Also, notice that the pod for Prometheus contains a
container named &quot;configmap-reload&quot; which is used to trigger a webhook on the Prometheus server when the
<a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer">Kubernetes config map</a> changes. This is necessary when changing the
Prometheus config, adding new scrape configs etc.</p><hr><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors-dovholuknf">authors: dovholuknf<a href="#authors-dovholuknf" class="hash-link" aria-label="Direct link to authors: dovholuknf" title="Direct link to authors: dovholuknf">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="applying-zero-trust-networking-principles-using-openziti">Applying Zero Trust Networking Principles Using OpenZiti<a href="#applying-zero-trust-networking-principles-using-openziti" class="hash-link" aria-label="Direct link to Applying Zero Trust Networking Principles Using OpenZiti" title="Direct link to Applying Zero Trust Networking Principles Using OpenZiti">​</a></h3><p>Now that we understand the basic setup and understand some possible problems, let&#x27;s see if OpenZiti can address one or more of these
issues. When applying OpenZiti, the goal will be to strengthen our security posture for each of the above items.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="figure-2---after-openziti">Figure 2 - After OpenZiti<a href="#figure-2---after-openziti" class="hash-link" aria-label="Direct link to Figure 2 - After OpenZiti" title="Direct link to Figure 2 - After OpenZiti">​</a></h4><p><img loading="lazy" alt="after" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-a-closer-look-after-openziti">Taking a Closer Look After OpenZiti<a href="#taking-a-closer-look-after-openziti" class="hash-link" aria-label="Direct link to Taking a Closer Look After OpenZiti" title="Direct link to Taking a Closer Look After OpenZiti">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="no-external-listening-ports">No External Listening Ports<a href="#no-external-listening-ports" class="hash-link" aria-label="Direct link to No External Listening Ports" title="Direct link to No External Listening Ports">​</a></h4><p>With a classic deployment as shown in the initial design, we know there will be ports exposed to the open internet. In an ideal scenario,
there would be absolutely no ports exposed on the open internet <strong>nor</strong> in the &quot;trusted networking zone&quot;. It&#x27;s immediately obvious after
applying a solution using OpenZiti that those listening ports exposed by the Kubernetes ingress controller are no longer deployed and thus
are no longer exposed to the internet. That&#x27;s one attack vector eliminated. OpenZiti will initiate outbound mTLS connections among all the
constituent pieces of the overlay network. This means connections will begin inside the trusted network zone and only create outbound
links. Once established, those connections can be used to safely transfer data between any participating edge node.</p><p>This capability really can&#x27;t be emphasized enough. With OpenZiti and with applications that use an OpenZiti SDK, such as the ones shown,
there are no open ports to attack. This network is nearly impervious to the classical &quot;land and expand&quot; technique so many bad actors
look to exploit.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-api-no-longer-exposed">Kubernetes API no Longer Exposed<a href="#kubernetes-api-no-longer-exposed" class="hash-link" aria-label="Direct link to Kubernetes API no Longer Exposed" title="Direct link to Kubernetes API no Longer Exposed">​</a></h4><p>Another significant benefit provided by OpenZiti is starting to come into focus. By having access to our clusters provided
through OpenZiti, we can <strong>stop exposing</strong> the Kubernetes APIs for both clusters to the open internet. Prometheus will still be able to
monitor each Kubernetes cluster through the private Kubernetes network. Accessing Prometheus will be provided via OpenZiti, instead of
using a Kubernetes ingress controller. Later, we can ues the built-in capability Prometheus already provides to federate information
from the clusters to a centralized, <a href="/blog/zitification">zitified</a> Prometheus server.</p><p>Once no longer exposed to the open internet, to maintain our Kubernetes cluster we could then turn to <!-- -->[zitified]<!-- -->
(/zitification/index.md) tools. The OpenZiti project provides zitified versions of <code>kubectl</code> -
<a href="https://github.com/openziti-test-kitchen/kubectl" target="_blank" rel="noopener noreferrer">kubeztl</a> and <code>helm</code> -
<a href="https://github.com/openziti-test-kitchen/helm" target="_blank" rel="noopener noreferrer">helmz</a>. Each of these tools have an OpenZiti SDK embedded inside them. This allows both
tools to connect to the private Kubernetes API over the OpenZiti overlay network. To use them, you will need a strong, OpenZiti identity
as well as be authorized to access the service. Also note that we&#x27;re also not replacing the existing security constraints the
Kubernetes ecosystem already provides. You can (and should) still secure your Kubernetes clusters using namespaces, roles, etc. </p><p>We&#x27;ll explore <code>kubeztl</code> and <code>helmz</code> in future articles.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-intra-cluster-traffic-1">&quot;Trusted&quot; Intra-cluster Traffic<a href="#trusted-intra-cluster-traffic-1" class="hash-link" aria-label="Direct link to &quot;Trusted&quot; Intra-cluster Traffic" title="Direct link to &quot;Trusted&quot; Intra-cluster Traffic">​</a></h4><p>Lastly, let&#x27;s turn our eyes toward the traffic running inside the Kubernetes cluster. Pay attention to the lines in orange and the lines in
dark blue. Orange lines represent &quot;private&quot; traffic, traffic that needs to traverse the private network space.</p><p>At this point we cannot send traffic to the Kubernetes API via the overlay network. The Kubernetes API doesn&#x27;t have an OpenZiti SDK
embedded within it. That means when we deploy Prometheus into ClusterA and ClusterB to monitor the cluster, Prometheus will be forced to
connect to a port exposed on the cluster&#x27;s underlay network. Still, while not ideal, we have greatly improved the overall security
posture of the cluster. We&#x27;re no longer able to access the Kubernetes API without first gaining access to the zero trust overlay
network. Accessing the Kubernetes API will also require the identity to be properly authorized to access the service attaching to the
Kubernetes API. </p><p>Let&#x27;s now focus on ClusterA. It contains a Prometheus server that decided against listening on the OpenZiti overlay. This means it
will need to expose ports to the Kubernetes underlay network. The container inside the Prometheus pod will watch for configmap
changes. To trigger the webhook, it will be forced to send unauthenticated webhook traffic to the Prometheus server on the underlay
network in order to trigger the config to reload.</p><p>Still, accessing this cluster and the listening Prometheus server will require being on the OpenZiti overlay. Also, this Prometheus
server does have an OpenZiti SDK built into it. We also deployed the &quot;reflectz&quot; workload with an OpenZiti SDK built into it as well.
That means the Prometheus server must scrape the &quot;reflectz&quot; workload exclusively over the OpenZiti overlay. <strong>Only</strong> authorized
identities can access that scrape data.</p><p>Contrast ClusterA with ClusterB. ClusterB deployed a Prometheus server with an embedded OpenZiti SDK and chose to provide its services
exclusively on the OpenZiti overlay. We&#x27;ve also deployed a zitified &quot;reflectz&quot; workload here. Notice how little traffic traverses the
Kubernetes cluster underlay network. The only traffic which needs to traverse the cluster&#x27;s underlay network in ClusterB is the traffic
which monitors the Kubernetes API. All other traffic in the cluster is now secured by the OpenZiti overlay network. You will
need a strong identity, and you will need to be authorized on the overlay before even being allowed to connect to the target service.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openziti-enabled-prometheus">OpenZiti-Enabled Prometheus<a href="#openziti-enabled-prometheus" class="hash-link" aria-label="Direct link to OpenZiti-Enabled Prometheus" title="Direct link to OpenZiti-Enabled Prometheus">​</a></h2><p>We are now coming to the final piece of the puzzle. We have protected both Kubernetes clusters using OpenZiti. Now we want to bring all
this data back to a centralized Prometheus server to make it easier on our user base. To do this, we&#x27;ll again deploy an OpenZiti-enabled
Prometheus server. This time we don&#x27;t care where it is deployed except that we know we are not deploying it into either of the Kubernetes
clusters we are already using. Since the Prometheus servers are all now accessible via the overlay network, we can literally deploy our
server anywhere in the world. It could be on development server, it could be deployed in some other cloud, it could be deployed in our
private data center. Because it&#x27;s part of the overlay network, it no longer matters where we deploy the server. Wherever deployed,
all it will need is outbound internet access, a strong identity, and access and authorization to services defined in the OpenZiti overlay
network. Once that&#x27;s done, OpenZiti will take care of the rest.</p><p>If you have made it this far you&#x27;re might want to try all this for yourself. The <a href="/blog/zitification/prometheus/part2">next article</a> will go into the details
necessary to implement this solution. When complete you&#x27;ll be able to deploy a zitified version of Prometheus and give Prometheus the power
to scrape anything from anywhere using OpenZiti.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/zitification/kubernetes"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Zitifying Kubectl</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/zitification/prometheus/part2"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Configuring OpenZiti to Enable Prometheus</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-problem-with-pulling" class="table-of-contents__link toc-highlight">The Problem With Pulling</a></li><li><a href="#prometheus" class="table-of-contents__link toc-highlight">Prometheus</a><ul><li><a href="#poll-based" class="table-of-contents__link toc-highlight">Poll-based?</a></li><li><a href="#acceptable-risk" class="table-of-contents__link toc-highlight">Acceptable Risk</a></li></ul></li><li><a href="#openziti" class="table-of-contents__link toc-highlight">OpenZiti</a><ul><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#taking-a-closer-look" class="table-of-contents__link toc-highlight">Taking a Closer Look</a></li></ul></li><li><a href="#authors-dovholuknf" class="table-of-contents__link toc-highlight">authors: dovholuknf</a><ul><li><a href="#applying-zero-trust-networking-principles-using-openziti" class="table-of-contents__link toc-highlight">Applying Zero Trust Networking Principles Using OpenZiti</a></li><li><a href="#taking-a-closer-look-after-openziti" class="table-of-contents__link toc-highlight">Taking a Closer Look After OpenZiti</a></li></ul></li><li><a href="#openziti-enabled-prometheus" class="table-of-contents__link toc-highlight">OpenZiti-Enabled Prometheus</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/policies/CODE_OF_CONDUCT">Policies</a><span class="footer__link-separator">·</span><a href="https://netfoundry.io/pricing/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CloudZiti</a><span class="footer__link-separator">·</span><a href="https://blog.openziti.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 NetFoundry Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.802e1845.js"></script>
<script src="/assets/js/main.9be12a4c.js"></script>
</body>
</html>