<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Configuring OpenZiti to Enable Prometheus | OpenZiti</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.openziti.io/blog/zitification/prometheus/part2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Configuring OpenZiti to Enable Prometheus | OpenZiti"><meta data-rh="true" name="description" content="_This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision"><meta data-rh="true" property="og:description" content="_This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-07-20T02:21:39.000Z"><meta data-rh="true" property="article:author" content="https://github.com/dovholuknf"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.openziti.io/blog/zitification/prometheus/part2"><link data-rh="true" rel="alternate" href="https://docs.openziti.io/blog/zitification/prometheus/part2" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.openziti.io/blog/zitification/prometheus/part2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EXWPKK5PV4-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenZiti RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenZiti Atom Feed">


<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-THVRRJ3GLE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-THVRRJ3GLE",{anonymize_ip:!0})</script>




<link rel="search" type="application/opensearchdescription+xml" title="OpenZiti" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.3659e858.css">
<link rel="preload" href="/assets/js/runtime~main.15d5ba0e.js" as="script">
<link rel="preload" href="/assets/js/main.051e8f04.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="root_VOM9"><span style="color:whitesmoke">Star us on GitHub </span><span style="height:20px"><span><a href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star buttons/github-buttons on GitHub">Star</a></span></span></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ziti-logo-dark.svg" alt="OpenZiti Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/ziti-logo-light.svg" alt="OpenZiti Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/learn/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/docs/downloads">Downloads</a><a href="https://blog.openziti.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li><div class="text-divider"><p>Socials</p></div></li><li><a href="https://www.youtube.com/OpenZiti" target="_blank" title="OpenZiti on YouTube"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/yt.svg">YouTube</span></a></li><li><a href="https://twitter.com/OpenZiti" target="_blank" title="OpenZiti on Twitter"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/twit.svg">Twitter</span></a></li><li><a href="https://www.reddit.com/r/openziti" target="_blank" title="OpenZiti Subreddit"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/reddit-logo.png">Reddit</span></a></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/ziggy.png"><a href="https://twitter.com/OpenZiggy" target="_blank" title="OpenZiggy on Twitter">Ziggy</a></span></li><li><div class="text-divider"><p>Other</p></div></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/blog-icon.png"><a href="https://blog.openziti.io/" target="_blank" title="Blog">Blog</a></span></li><li><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/oz-test-kitchen.png"><a href="https://github.com/openziti-test-kitchen" target="_blank" title="Git project for the test kitchen">Test Kitchen</a></span></li><li><a href="https://zeds.openziti.org" target="_blank" title="Developer Sandbox"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/zeds.png">ZEDS</span></a></li><li><a href="https://netfoundry.io/pricing/" target="_blank" title="NetFoundry-hosted Ziti"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/img/nf.svg">CloudZiti</span></a></li></ul></div><a href="https://openziti.discourse.group/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discourse-link" title="Discourse"></a><a href="https://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_eExm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/articles">Articles</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/c-sdk-on-beaglebone">Building the Ziti C SDK and Sample Apps for arm (BeagleBone)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-01.encryption-everywhere">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-02.a-primer-on-public-key-cryptography">Bootstrapping Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/bootstrapping-trust/part-03.certificates">Bootstrapping Trust</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Configuring OpenZiti to Enable Prometheus</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-07-20T02:21:39.000Z" itemprop="datePublished">July 20, 2023</time> · <!-- -->20 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/46322585?v=4" alt="Clint Dovholuk"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/dovholuknf" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Clint Dovholuk</span></a></div><small class="avatar__subtitle" itemprop="description">OpenZiti Maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><em>This is part two of a three-part article. This article provides the technical deep dive into the steps necessary to implement the vision
outlined in <a href="/blog/zitification/prometheus/part1">part one</a>. This article will be heavy on OpenZiti CLI commands, explaining what we are doing to configure the
overlay network, and why. In <a href="/blog/zitification/prometheus/part3">the final article</a>, we will explore what we have just created and understand what was just
created</em></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h2><ul><li>Incredibly easy to deploy Prometheus servers</li><li>No ports exposed to the internet</li><li>Prometheus servers can be deployed listening on the overlay, not on the underlay</li><li>Private Kubernetes API</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zitified-prometheus">Zitified Prometheus<a href="#zitified-prometheus" class="hash-link" aria-label="Direct link to Zitified Prometheus" title="Direct link to Zitified Prometheus">​</a></h2><p>As described in <a href="/blog/zitification/prometheus/part1">the previous article</a>, Prometheus really prefers to be able to gather metrics from the targets it is
monitoring. When the target is behind a firewall, you will be left with two choices.
<img loading="lazy" src="https://github.com/openziti/branding/raw/main/images/ziggy/svg/Ziggy%20The%20Superhero.svg" alt="superhero" class="img_ev3q">
You can choose to open a hole in the firewall granting access (a generally bad idea), or you can use a PushGateway. Even if you choose to
use the PushGateway, Prometheus will still need to be able to access and pull from the PushGateway so you&#x27;ll still need some port open and
listening for Prometheus to collect data.</p><p>What we really want is to enable Prometheus to scrape data from targets without needing to expose any ports to the internet. It would be <strong>
even better</strong> if we didn&#x27;t have to expose any ports at all, even to the local &quot;trusted&quot; network. This capability is something that is
unique to an OpenZiti-enabled application. You can take an OpenZiti SDK and embed it into your application, and give your app zero trust
superpowers! If we take an OpenZiti SDK and embed it into Prometheus, we can give Prometheus the superpower of invisibility and
addressability. Embedding an OpenZiti SDK produces a <a href="/blog/zitification">zitified</a> version of Prometheus. With an
OpenZiti-powered Prometheus, no ports need to be open.</p><p>The OpenZiti project has done the work to produce an OpenZiti-enabled version of Prometheus. It&#x27;s also entirely open source. Check it out
from the OpenZiti Test Kitchen hosted on GitHub <a href="https://github.com/openziti-test-kitchen/prometheus" target="_blank" rel="noopener noreferrer">https://github.com/openziti-test-kitchen/prometheus</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution-overview">Solution Overview<a href="#solution-overview" class="hash-link" aria-label="Direct link to Solution Overview" title="Direct link to Solution Overview">​</a></h2><p>As you&#x27;ll recall from <a href="/blog/zitification/prometheus/part1">part1</a>, we are trying to use Prometheus to monitor workloads in two different
Kubernetes clusters. We are going to deploy one cluster which will represent a first step of an OpenZiti solution.
It will use a Prometheus sever which is OpenZiti-enabled, but it will still listen on the underlay network and be
available to local devices on an ip:port. This Prometheus server will use OpenZiti to scrape targets which
are available anywhere on the OpenZiti overlay network and we&#x27;ll refer to this as &quot;ClusterA&quot;.</p><p>We&#x27;ll also deploy a second OpenZiti-enabled Prometheus server, in a totally separate Kubernetes cluster. This
Prometheus server will <strong>not</strong> listen on an ip:port. Instead, it will listen exclusively on the OpenZiti overlay.
This Prometheus server will have no ports available to attack and will only be accessible via a properly authorized
and authenticated OpenZiti client. This will be our &quot;ClusterB&quot;</p><p>Finally, we&#x27;ll stand up a third Prometheus server and use it to federate metrics back to a &quot;central&quot; Prometheus
server. This emulates what one might do to provide a central location for humans to go to in order to visualize data
or use the Prometheus server. We won&#x27;t care where this is deployed, we&#x27;ll actually deploy it in locally and then
move it to a private server in AWS just to show how easy it that is. </p><p>This is what the solution we&#x27;ll build looks like:
<img loading="lazy" alt="after" src="/assets/images/kubernetes-prometheus-after-1c432161cd5ceac47eadc4149cae35fb.svg" width="1264" height="531" class="img_ev3q"></p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="digging-in">Digging In<a href="#digging-in" class="hash-link" aria-label="Direct link to Digging In" title="Direct link to Digging In">​</a></h2><p>Let&#x27;s get to work and build this solution. We&#x27;ll need some legwork done first. </p><blockquote><p>[!NOTE]<!-- -->
It&#x27;s going to get deep in this article with CLI commands. You&#x27;ll see what the OpenZiti objects are that get created and learn why.
You might not want to replicate the solution on your own and instead are looking for &quot;the big reveal&quot;. If that describes you, just
skim this article lightly and get on to <a href="/blog/zitification/prometheus/part3">part3</a>. In part 3 we&#x27;ll explore the deployed solution and see what makes it so
interesting and cool.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3><p><img loading="lazy" src="https://github.com/openziti/branding/raw/main/images/ziggy/svg/Ziggy%20The%20Construction%20Worker.svg" alt="construction worker" class="img_ev3q"></p><ul><li>You have an OpenZiti overlay network available. If not, for this scenario you will want to use
<a href="/docs/learn/quickstarts/network/hosted">&quot;host your own&quot;</a>. You&#x27;ll also want to have the ziti cli tool on your path</li><li>Two Kubernetes clusters provisioned</li><li>Necessary tooling installed and available on the path<ul><li>kubectl</li><li>helm</li></ul></li><li>bash/zsh shell - tested in bash and some commands will use variables. If you use another shell, change accordingly</li><li>a machine with <a href="https://docs.docker.com/get-docker/" target="_blank" rel="noopener noreferrer">docker installed</a> to run the final Prometheus sever on (your local machine is fine)</li><li>Ziti Desktop Edge installed on the development machine. I use
<a href="https://github.com/openziti/desktop-edge-win/releases/latest/" target="_blank" rel="noopener noreferrer">Ziti Desktop Edge for Windows</a>.</li><li>A temporary folder exists to house files as we need them: /tmp/prometheus</li></ul><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clustera---using-ziti-host">ClusterA - Using <code>ziti-host</code><a href="#clustera---using-ziti-host" class="hash-link" aria-label="Direct link to clustera---using-ziti-host" title="Direct link to clustera---using-ziti-host">​</a></h2><p><img loading="lazy" alt="clusterA" src="/assets/images/clusterA-71f957b6205e44af29d35d4d65efc06b.svg" width="349" height="505" class="img_ev3q"></p><p>We start with an empty OpenZiti network, and two empty Kubernetes clusters. Let&#x27;s start by populating ClusterA. We will deploy three
pods into this Kubernetes cluster. When done, the Kubernetes cluster will look similar to the image to the right.</p><ul><li>Pod 1. <strong>ziti-host</strong>. This pod will provide what is effectively the equivalent of a Kubernetes ingress controller. We&#x27;ll install this
using helm from a NetFoundry provided chart</li><li>Pod 2. <strong>prometheuz</strong>. This pod will be our Prometheus server with OpenZiti embedded in it. We won&#x27;t use OpenZiti to listen on the
overlay network. Instead, we will follow a more traditional model of listening on the underlay at a known ip:port combination. We&#x27;ll
install this pod using a chart from the OpenZiti charts repository.</li><li>Pod 3. <strong>reflectz</strong>. This pod represents the workload which we want to monitor. This is another chart provided by the OpenZiti chart
repository and will also be installed with helm. If you are interested in viewing the source code for this project you can find it on
<a href="https://github.com/nf-npieros/sdk-golang/tree/feature/reflect-prometheus" target="_blank" rel="noopener noreferrer">GitHub here</a></li></ul><blockquote><p>[!NOTE]<!-- -->
Running the ziti cli commands shown below as shown will expect you to have the ziti binary on your path. Also it is expected that all
the commands run will run from the same &quot;development&quot; machine with the expected tools available. Reach out on discourse if you get stuck.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-1---ziti-host">Pod 1 - <code>ziti-host</code><a href="#pod-1---ziti-host" class="hash-link" aria-label="Direct link to pod-1---ziti-host" title="Direct link to pod-1---ziti-host">​</a></h3><p>We will start off deploying Pod 1, ziti-host, to provide access to Kubernetes ClusterA.  The ziti-host pod will require a single
identity to be provisioned. We will use a shortened name for the cluster and we&#x27;ll embed that name into the identity to make it easier
for us to understand what identity we provisioned and why, should we ever need to reference these identities later.  We&#x27;ll refer to
ClusterA as simply &quot;kubeA&quot;. Let&#x27;s make the identity now. Notice we are also passing the &quot;-a&quot; attribute during creation to add a role
attribute to the identity of <code>kubeA.services</code>. This will be used later when setting up policies.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity">Create the Identity<a href="#create-the-identity" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity device kubeA.ziti.id -o /tmp/prometheus/kubeA.ziti.id.jwt -a &quot;kubeA.services&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see confirmation output such as:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">New identity kubeA.ziti.id created with id: BeyyFUZFDR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enrollment expires at 2022-04-22T01:18:53.402Z</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-ziti-host-into-clustera">Deploy <code>ziti-host</code> into ClusterA<a href="#deploy-ziti-host-into-clustera" class="hash-link" aria-label="Direct link to deploy-ziti-host-into-clustera" title="Direct link to deploy-ziti-host-into-clustera">​</a></h4><p>Once created, we can use helm to install the <code>ziti-host</code> pod. The jwt is a one-use token and will be useless after being consumed by
<code>ziti-host</code>. As this is probably your first time running this helm chart, you will need to install it. The command is idempotent to
running it over and over is of no concern. Run the following:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add netfoundry https://netfoundry.github.io/charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install ziti-host netfoundry/ziti-host --set-file enrollmentToken=&quot;/tmp/prometheus/kubeA.ziti.id.jwt&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will see the confirmation output from helm. Now when you look at your Kubernetes cluster with <code>kubectl</code>, you will see a pod deployed:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-db55b5c4b-rpc7f   1/1     Running   0          2m40s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Awesome, we have our first deployed pod. It&#x27;s useless at the moment as we have defined no services, nor authorized any services. Right
now there&#x27;s nothing to connect to, so we can simply move on and install the next pod, <code>reflectz</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-2---reflectz">Pod 2 - <code>reflectz</code><a href="#pod-2---reflectz" class="hash-link" aria-label="Direct link to pod-2---reflectz" title="Direct link to pod-2---reflectz">​</a></h3><p>The first pod we want to have access to is the <code>reflectz</code> pod. It is a workload we will deploy that will do two things. First, it will
listen on the OpenZiti overlay network for connections. When a connection is made, and when bytes are sent, the workload sill simply
return back to the caller whatever was sent to it adding &quot;you sent me: &quot; to the payload. It&#x27;s not much, but it&#x27;s a demo after all. The
second service provided is a scrape target for Prometheus. There is one metric exposed by <code>reflectz</code> we will care about, the total number of connections established to this workload. This pod also needs an identity provisioned, and this time around we will also provision some services. We will also use the <code>ziti</code> cli to enroll this identity. This helm chart wants you to provide an enrolled identity as part of the helm command. Let&#x27;s do all this now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-enroll-the-identity">Create and Enroll the Identity<a href="#create-and-enroll-the-identity" class="hash-link" aria-label="Direct link to Create and Enroll the Identity" title="Direct link to Create and Enroll the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeA.reflect.id -o /tmp/prometheus/kubeA.reflect.id.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeA.reflect.id.jwt -o /tmp/prometheus/kubeA.reflect.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">​</a></h4><p>The <code>reflectz</code> chart also needs two services to be declared and specified at the time of the helm chart installation. We will want to be
able to test the service to ensure they work. To enable testing the services, we will create two configs of type <code>intercept.v1</code>. This
will allow identities using tunneling apps to be able to access the services, this is how we&#x27;ll verify the services work. Make the
configs and services now.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create intercept configs for the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config kubeA.reflect.svc-intercept.v1 intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeA.reflect.svc.ziti&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeA.reflect.svc-intercept.v1.scrape&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeA.reflect.scrape.svc.ziti&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;:{&quot;identity&quot;:&quot;kubeA.reflect.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeA.reflect.svc&quot; --configs &quot;kubeA.reflect.svc-intercept.v1&quot; -a &quot;kubeA.reflect.svc.services&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeA.reflect.scrape.svc&quot; --configs &quot;kubeA.reflect.svc-intercept.v1.scrape&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-and-clients">Authorize the Workload and Clients<a href="#authorize-the-workload-and-clients" class="hash-link" aria-label="Direct link to Authorize the Workload and Clients" title="Direct link to Authorize the Workload and Clients">​</a></h4><p>Services are not valuable if there are no identities which can use the services. The identity used in the helm installation will also
need to be authorized to bind these services. Tunneling apps will need to be authorized to dial these services but also remember
Prometheus servers will need to be able to dial these services too. We will now create <code>service-policies</code> to authorize the tunneling
clients, Prometheus scrapes, and the <code>reflectz</code> server to bind the service.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the bind service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.svc&quot; --identity-roles &quot;@kubeA.reflect.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.scrape.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.scrape.svc&quot; --identity-roles &quot;@kubeA.reflect.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the dial service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.reflect.svc.dial.scrape&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.reflect.scrape.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-reflectz">Deploy <code>reflectz</code><a href="#deploy-reflectz" class="hash-link" aria-label="Direct link to deploy-reflectz" title="Direct link to deploy-reflectz">​</a></h4><p>With the identity enrolled, we can now install the helm chart from openziti, and install our demonstration workload: <code>reflectz</code>. Notice
that to deploy <code>reflectz</code> we need to supply an identity to the workload using <code>--set-file reflectIdentity</code>. This identity will be used
to &#x27;Bind&#x27; the services the workload exposes. We also need to define what the service names are we want to allow that identity to bind.
We do this using the <code>--set serviceName</code> and <code>--set prometheusServiceName</code> flags.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install reflectz openziti-test-kitchen/reflect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file reflectIdentity=&quot;/tmp/prometheus/kubeA.reflect.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set serviceName=&quot;kubeA.reflect.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set prometheusServiceName=&quot;kubeA.reflect.scrape.svc&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After running helm, pod 2 should be up and running. Let&#x27;s take a look using <code>kubectl</code></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reflectz-775bd45d86-4sjwh   1/1     Running   0          7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti-host-db55b5c4b-rpc7f   1/1     Running   0          4m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-3---prometheuz">Pod 3 - <code>Prometheuz</code><a href="#pod-3---prometheuz" class="hash-link" aria-label="Direct link to pod-3---prometheuz" title="Direct link to pod-3---prometheuz">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="overlay-work---setting-up-openziti">Overlay Work - Setting Up OpenZiti<a href="#overlay-work---setting-up-openziti" class="hash-link" aria-label="Direct link to Overlay Work - Setting Up OpenZiti" title="Direct link to Overlay Work - Setting Up OpenZiti">​</a></h4><p>Now we have access to the cluster and a workload to monitor. Now we want to deploy Prometheus and monitor this workload. Remember that
the workload only exposes a scrape target over the OpenZiti overlay. For Prometheus to be able to scrape the workload, even when
resident inside the Kubernetes cluster (!), Prometheus will need to be OpenZiti-enabled. That will require a few things. We&#x27;ll need a
new identity for Prometheus, we&#x27;ll need to authorize Prometheus to access the workload&#x27;s target, and we&#x27;ll need to configure Prometheus
to scrape that workload. When we create this identity we&#x27;ll assign two attributes. The <code>reflectz-clients</code> attribute gives this identity
the ability to dial the two services defined above. The <code>prometheus-clients</code> attribute is currently unused. We&#x27;ll put that to use later,
but we can define it now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-and-enroll-the-identity-1">Create and Enroll the Identity<a href="#create-and-enroll-the-identity-1" class="hash-link" aria-label="Direct link to Create and Enroll the Identity" title="Direct link to Create and Enroll the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create and enroll the identity.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeA.prometheus.id -o /tmp/prometheus/kubeA.prometheus.id.jwt -a &quot;reflectz-clients&quot;,&quot;prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeA.prometheus.id.jwt -o /tmp/prometheus/kubeA.prometheus.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access-1">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access-1" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the kubeA prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeA.prometheus.svc-intercept.v1&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeA.prometheus.svc&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeA.prometheus.svc-host.v1&quot; host.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocol&quot;:&quot;tcp&quot;, &quot;address&quot;:&quot;prometheuz-prometheus-server&quot;,&quot;port&quot;:80}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeA.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs &quot;kubeA.prometheus.svc-intercept.v1&quot;,&quot;kubeA.prometheus.svc-host.v1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-and-clients-1">Authorize the Workload and Clients<a href="#authorize-the-workload-and-clients-1" class="hash-link" aria-label="Direct link to Authorize the Workload and Clients" title="Direct link to Authorize the Workload and Clients">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the kubeA.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.prometheus.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;#prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeA.prometheus.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeA.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;@kubeA.ziti.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-prometheuz-1">Deploying <code>Prometheuz</code><a href="#deploying-prometheuz-1" class="hash-link" aria-label="Direct link to deploying-prometheuz-1" title="Direct link to deploying-prometheuz-1">​</a></h4><p>With our services, configs and service-policies in place we are now ready to start our Prometheus server. Remember this server will not
listen on a the OpenZiti overlay. It&#x27;s going to listen exclusively on the underlay. We are still exploring OpenZiti, and we are not yet
comfortable deploying our Prometheus server dark. We&#x27;ll change this soon, don&#x27;t worry. For now, we&#x27;ll imagine that we&#x27;re still
evaluating the tech and chose to deploy it on the underlay, not on the overlay. </p><p>Although Prometheus is listening on the underlay, we <strong>have</strong> deployed our workload listening on the overlay network. It won&#x27;t be
available on the underlay at all. The workload has <strong>no listening ports</strong>. This means that we&#x27;ll still need an OpenZiti-enabled
Prometheus to access and scrape that workload. To do this we&#x27;ll use helm, and use a chart provided by the OpenZiti charts repo.</p><p>Some interesting things to notice below in the <code>helm install</code> command. Notice that we are passing helm two <code>--set</code> parameters. These
parameters are informing the helm chart that the Prometheus server is not &quot;zitified&quot;, meaning it will be accessible via the underlay
network. We&#x27;re also passing one <code>--set-file</code> parameter to tell Prometheus what identity we want to be stored in the pod (as a secret).
This secret will be used when we configure Prometheus to scrape the workload. Go ahead and run this command now and run
<code>kubectl get pods</code> until all the containers are running.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheuz openziti-test-kitchen/prometheus \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set server.ziti.enabled=&quot;false&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.scrape.id.contents=&quot;/tmp/prometheus/kubeA.prometheus.id.json&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clusterb---fully-dark">ClusterB - Fully Dark<a href="#clusterb---fully-dark" class="hash-link" aria-label="Direct link to ClusterB - Fully Dark" title="Direct link to ClusterB - Fully Dark">​</a></h2><p><img loading="lazy" alt="clusterB" src="/assets/images/clusterB-9e8019e9f78c665bd67f52585250b986.svg" width="349" height="447" class="img_ev3q"></p><p>Now that we have deployed our first Kubernetes cluster, it&#x27;s now time to deploy the second Kubernetes cluster. This time, we are going
to keep our entire deployment <strong>fully dark</strong>! There will be no listening ports, not even local to the Kubernetes cluster itself. To get
any traffic to this Prometheus server, you will need a strong identity and need to be authorized on the OpenZiti overlay. When complete,
ClusterB will look like the image to the right.</p><p>This time, &quot;Pod1&quot; will be the <code>reflectz</code> workload. Since this is a <strong>fully dark</strong> deployment, listening entirely on the OpenZiti overlay,
we won&#x27;t need a <code>ziti-host</code> pod. Remember, in ClusterA <code>ziti-host</code> is used to provide internal access to the Kubernetes cluster via the
OpenZiti overlay. It&#x27;s similar in role to an ingress controller, but doesn&#x27;t require you to expose your workloads to the internet. While
that&#x27;s pretty good we want to go fully dark this time. We&#x27;ll have no <code>ziti-host</code>. We&#x27;ll only need to deploy two pods: <code>reflectz</code> and
<code>prometheuz</code>.</p><p>The good news is that the same commands you&#x27;ve run for ClusterA, will mostly be used for ClusterB. You will want to beware that where
you used &quot;kubeA&quot; before, make sure you change those to &quot;kubeB&quot;. There will be small other changes we&#x27;ll make along the way too, we&#x27;ll see
those changes and explain them below. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod1---reflectz">Pod1 - <code>reflectz</code><a href="#pod1---reflectz" class="hash-link" aria-label="Direct link to pod1---reflectz" title="Direct link to pod1---reflectz">​</a></h3><p>The <code>relectz</code> workload we&#x27;ll deploy for ClusterB will be nearly identical to the ClusterA workload. We will create a service for
the actual &#x27;reflect&#x27; service. We will make a service for Prometheus to scrape the workload. We&#x27;ll also need another identity, so
we&#x27;ll create that identity, authorize it to bind the services, and authorize clients to access the workload. Since this process is very
similar to what we did for ClusterA, there&#x27;s not much to explain. Setup ClusterB&#x27;s <code>reflectz</code> now.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity-1">Create the Identity<a href="#create-the-identity-1" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeB.reflect.id -o /tmp/prometheus/kubeB.reflect.id.jwt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeB.reflect.id.jwt -o /tmp/prometheus/kubeB.reflect.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-configs-and-services-including-tunneling-based-access-2">Create Configs and Services (including Tunneling-based Access)<a href="#create-configs-and-services-including-tunneling-based-access-2" class="hash-link" aria-label="Direct link to Create Configs and Services (including Tunneling-based Access)" title="Direct link to Create Configs and Services (including Tunneling-based Access)">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create intercept configs for the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config kubeB.reflect.svc-intercept.v1 intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeB.reflect.svc.ziti&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeB.reflect.svc-intercept.v1.scrape&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeB.reflect.scrape.svc.ziti&quot;], &quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;:{&quot;identity&quot;:&quot;kubeB.reflect.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the two services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeB.reflect.svc&quot; --configs &quot;kubeB.reflect.svc-intercept.v1&quot; -a &quot;kubeB.reflect.svc.services&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeB.reflect.scrape.svc&quot; --configs &quot;kubeB.reflect.svc-intercept.v1.scrape&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-the-workload-to-bind-the-services">Authorize the Workload to Bind the Services<a href="#authorize-the-workload-to-bind-the-services" class="hash-link" aria-label="Direct link to Authorize the Workload to Bind the Services" title="Direct link to Authorize the Workload to Bind the Services">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the bind service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.svc&quot; --identity-roles &quot;@kubeB.reflect.id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.scrape.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.scrape.svc&quot; --identity-roles &quot;@kubeB.reflect.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-clients-to-access-the-services">Authorize Clients to Access the Services<a href="#authorize-clients-to-access-the-services" class="hash-link" aria-label="Direct link to Authorize Clients to Access the Services" title="Direct link to Authorize Clients to Access the Services">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the dial service policies and authorize the reflect id to bind these services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.reflect.svc.dial.scrape&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.reflect.scrape.svc&quot; --identity-roles &quot;#reflectz-clients&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-reflectz-1">Deploy <code>reflectz</code><a href="#deploy-reflectz-1" class="hash-link" aria-label="Direct link to deploy-reflectz-1" title="Direct link to deploy-reflectz-1">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install reflectz openziti-test-kitchen/reflect \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file reflectIdentity=&quot;/tmp/prometheus/kubeB.reflect.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set serviceName=&quot;kubeB.reflect.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set prometheusServiceName=&quot;kubeB.reflect.scrape.svc&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pod-2---prometheuz">Pod 2 - <code>Prometheuz</code><a href="#pod-2---prometheuz" class="hash-link" aria-label="Direct link to pod-2---prometheuz" title="Direct link to pod-2---prometheuz">​</a></h3><p>For ClusterB we want <code>Prometheuz</code> to be <strong>totally dark</strong>. It will exclusively listen on the OpenZiti overlay and there will be no
listening ports on the underlay. We will need another identity, of course, and most of the configuration and commands appear the same on
the surface with very subtle differences. We&#x27;ll explore these differences as we go. In this section we&#x27;ll be making an identity, <strong>one
config</strong> (a difference from the ClusterA install), a service, and two service-policies. Let&#x27;s get to it.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-the-identity-2">Create the Identity<a href="#create-the-identity-2" class="hash-link" aria-label="Direct link to Create the Identity" title="Direct link to Create the Identity">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create identity user kubeB.prometheus.id -o /tmp/prometheus/kubeB.prometheus.id.jwt -a &quot;reflectz-clients&quot;,&quot;prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge enroll /tmp/prometheus/kubeB.prometheus.id.jwt -o /tmp/prometheus/kubeB.prometheus.id.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-one-config-and-service">Create <strong>One</strong> Config and Service<a href="#create-one-config-and-service" class="hash-link" aria-label="Direct link to create-one-config-and-service" title="Direct link to create-one-config-and-service">​</a></h4><p>Here&#x27;s a difference from ClusterA. Since we are going to listen on the OpenZiti overlay, we are not installing <code>ziti-host</code>. That means
we don&#x27;t need to create a <code>host.v1</code> config. A <code>host.v1</code> config is necessary for services which have a &#x27;Bind&#x27; configuration and are being
bound by a tunneling application. We&#x27;re not doing that, here Prometheus will &#x27;Bind&#x27; this service, thus we don&#x27;t need that <code>host.v1</code>
config.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># create the config and service for the kubeB prometheus server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create config &quot;kubeB.prometheus.svc-intercept.v1&quot; intercept.v1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &#x27;{&quot;protocols&quot;:[&quot;tcp&quot;],&quot;addresses&quot;:[&quot;kubeB.prometheus.svc&quot;],&quot;portRanges&quot;:[{&quot;low&quot;:80, &quot;high&quot;:80}], &quot;dialOptions&quot;: {&quot;identity&quot;:&quot;kubeB.prometheus.id&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># no need for the host.v1 config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service &quot;kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --configs &quot;kubeB.prometheus.svc-intercept.v1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorize-clients-and-prometheus-to-bind-the-service">Authorize Clients and Prometheus to Bind the Service<a href="#authorize-clients-and-prometheus-to-bind-the-service" class="hash-link" aria-label="Direct link to Authorize Clients and Prometheus to Bind the Service" title="Direct link to Authorize Clients and Prometheus to Bind the Service">​</a></h4><p>At first, these commands appear identical. You need to look very closely to notice the difference between these command and the ones we
ran for ClusterA, other than the obvious changes from &quot;kubeA&quot; to &quot;kubeB&quot;. Pay close attention to the supplied <code>--identity-roles</code> for the
bind policy specified below. With ClusterA, we did not have Prometheus listen on the overlay and we allowed Prometheus to listen on the
underlay. That meant we needed to deploy <code>ziti-host</code> into that cluster to provide access to the service, and that means the service had
to be bound by the <code>ziti-host</code> identity.</p><p>Here we are flipping that script. We are allowing Prometheus to bind this service! That means we&#x27;ll need to authorize the
<code>kubeB.prometheus.id</code> to be able to bind the service.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># grant the prometheus clients the ability to dial the service and the kubeB.prometheus.id the ability to bind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.prometheus.svc.dial&quot; Dial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;#prometheus-clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ziti edge create service-policy &quot;kubeB.prometheus.svc.bind&quot; Bind \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --service-roles &quot;@kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --identity-roles &quot;@kubeB.prometheus.id&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-prometheuz">Deploying <code>Prometheuz</code><a href="#deploying-prometheuz" class="hash-link" aria-label="Direct link to deploying-prometheuz" title="Direct link to deploying-prometheuz">​</a></h4><p>At this point we have the OpenZiti overlay all configured. What&#x27;s left, is to deploy Prometheus into ClusterB. This command is substantially
different from what we ran while deploying Prometheus into ClusterA. You&#x27;ll see that we need to supply two other identities for this
installation. Remember, Prometheus will be entirely dark once deployed into ClusterB, listening only on the OpenZiti overlay. The container
in the pod which monitors configmap changes won&#x27;t be able to trigger a webhook using the underlay! This <code>configmap-reloadz</code> is a second
&quot;zitification&quot; we didn&#x27;t realize we were deploying in ClusterA, because we did not need it. We need it for ClusterB.</p><p>You&#x27;ll see for configmapReload we need to supply the identity which the container will use to hit the Prometheus webhook. We do that by
passing <code>--set-file configmapReload.ziti.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot;</code>. Then we&#x27;ll supply the service which
<code>configmap-reloadz</code> will dial, and we&#x27;ll also specify what identity we expect to be hosting the service.</p><p>Next you&#x27;ll see we need to supply the identity to the Prometheus server we want to allow to listen on the OpenZiti overlay (
<code>-set-file server.ziti.id.contents</code>). Similar to <code>configmap-reloadz</code> we will also specify the service and identity name to bind.</p><p>Finally, to allow the server to scrape targets we need to supply a final identity which will be used when scraping targets with
<code>--set-file server.scrape.id.contents</code>.</p><p>You&#x27;ll notice for simplicities sake, we are using the same identity for all three needs which is perfectly fine. If you wanted to use a
different identity, you could. That choice is up to you. To keep it simple we just authorized this identity for all these purposes.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># install prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add openziti-test-kitchen https://openziti-test-kitchen.github.io/helm-charts/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install prometheuz openziti-test-kitchen/prometheus \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file configmapReload.ziti.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set configmapReload.ziti.targetService=&quot;kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set configmapReload.ziti.targetIdentity=&quot;kubeB.prometheus.id&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.ziti.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set server.ziti.service=&quot;kubeB.prometheus.svc&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       --set server.ziti.identity=&quot;kubeB.prometheus.id&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --set-file server.scrape.id.contents=&quot;/tmp/prometheus/kubeB.prometheus.id.json&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="whats-next">What&#x27;s Next<a href="#whats-next" class="hash-link" aria-label="Direct link to What&#x27;s Next" title="Direct link to What&#x27;s Next">​</a></h2><p>In this article we&#x27;ve done a lot of OpenZiti CLI work, run some <code>kubectl</code> and <code>helm</code> commands but we still haven&#x27;t explored what it is
we are building and why it&#x27;s so cool. We&#x27;ll do that in the <a href="/blog/zitification/prometheus/part3">last, and final</a> article. Hopefully, the payoff for you will be
as rewarding as it was for me while building this article series.</p><hr><h4 class="anchor anchorWithStickyNavbar_LWe7" id="addendum---a-quicker-start">Addendum - a Quicker Start<a href="#addendum---a-quicker-start" class="hash-link" aria-label="Direct link to Addendum - a Quicker Start" title="Direct link to Addendum - a Quicker Start">​</a></h4><p>All the commands above are also available in github as <code>.sh</code> scripts. If you would prefer, you can clone the
<a href="https://github.com/openziti/ziti-doc" target="_blank" rel="noopener noreferrer">ziti-doc repository</a> and access the scripts from the path mentioned below. &quot;Cleanup&quot; scripts are
provided if desired. </p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">${checkout_root}/docusaurus/blog/zitification/prometheus/scripts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/zitification/prometheus/part1"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Enable Prometheus to Scrape Anything from Anywhere</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/zitification/prometheus/part3"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Scraping Anything, Anywhere in Action</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li><li><a href="#zitified-prometheus" class="table-of-contents__link toc-highlight">Zitified Prometheus</a></li><li><a href="#solution-overview" class="table-of-contents__link toc-highlight">Solution Overview</a></li><li><a href="#digging-in" class="table-of-contents__link toc-highlight">Digging In</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li></ul></li><li><a href="#clustera---using-ziti-host" class="table-of-contents__link toc-highlight">ClusterA - Using <code>ziti-host</code></a><ul><li><a href="#pod-1---ziti-host" class="table-of-contents__link toc-highlight">Pod 1 - <code>ziti-host</code></a></li><li><a href="#pod-2---reflectz" class="table-of-contents__link toc-highlight">Pod 2 - <code>reflectz</code></a></li><li><a href="#pod-3---prometheuz" class="table-of-contents__link toc-highlight">Pod 3 - <code>Prometheuz</code></a></li></ul></li><li><a href="#clusterb---fully-dark" class="table-of-contents__link toc-highlight">ClusterB - Fully Dark</a><ul><li><a href="#pod1---reflectz" class="table-of-contents__link toc-highlight">Pod1 - <code>reflectz</code></a></li><li><a href="#pod-2---prometheuz" class="table-of-contents__link toc-highlight">Pod 2 - <code>Prometheuz</code></a></li></ul></li><li><a href="#whats-next" class="table-of-contents__link toc-highlight">What&#39;s Next</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/policies/CODE_OF_CONDUCT">Policies</a><span class="footer__link-separator">·</span><a href="https://netfoundry.io/pricing/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CloudZiti</a><span class="footer__link-separator">·</span><a href="https://blog.openziti.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 NetFoundry Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.15d5ba0e.js"></script>
<script src="/assets/js/main.051e8f04.js"></script>
</body>
</html>