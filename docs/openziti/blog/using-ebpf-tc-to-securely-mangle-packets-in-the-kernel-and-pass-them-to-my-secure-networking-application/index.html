<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true"></title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="robots" content="index, follow"><meta data-rh="true" property="og:title" content="Using eBPF-TC to securely mangle packets in the kernel, and pass them to my secure networking application | OpenZiti"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:image" content="http://localhost:3000/@site/blogs/openziti/v1668008121762/C4XmMYoVT.jpg"><meta data-rh="true" name="twitter:image" content="http://localhost:3000/@site/blogs/openziti/v1668008121762/C4XmMYoVT.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-09T22:10:42.000Z"><meta data-rh="true" property="article:author" content="https://github.com/r-caamano"><meta data-rh="true" property="article:tag" content="Open Source,Firewall,OpenZiti,eBPF,tc,TProxy"><meta data-rh="true" data-rh="true" name="nf-layout-version" content="0.0.168"><meta data-rh="true" name="twitter:card" content="summary_large_image"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application"><link data-rh="true" rel="alternate" href="http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EXWPKK5PV4-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application","mainEntityOfPage":"http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application","url":"http://localhost:3000/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application","headline":"Using eBPF-TC to securely mangle packets in the kernel, and pass them to my secure networking application","name":"Using eBPF-TC to securely mangle packets in the kernel, and pass them to my secure networking application","description":"Introduction","datePublished":"2022-11-09T22:10:42.000Z","author":{"@type":"Person","name":"Robert Caamano","description":"Author","url":"https://github.com/r-caamano","image":"https://avatars.githubusercontent.com/r-caamano"},"image":{"@type":"ImageObject","@id":"http://localhost:3000/@site/blogs/openziti/v1668008121762/C4XmMYoVT.jpg","url":"http://localhost:3000/@site/blogs/openziti/v1668008121762/C4XmMYoVT.jpg","contentUrl":"http://localhost:3000/@site/blogs/openziti/v1668008121762/C4XmMYoVT.jpg","caption":"title image for the blog post: Using eBPF-TC to securely mangle packets in the kernel, and pass them to my secure networking application"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"http://localhost:3000/docs/openziti/blog","name":"Blog"}}</script><script>!function(t,h,e,j,s,n){t.hj=t.hj||function(){(t.hj.q=t.hj.q||[]).push(arguments)},t._hjSettings={hjid:3576473,hjsv:6},s=h.getElementsByTagName("head")[0],(n=h.createElement("script")).async=1,n.src="https://static.hotjar.com/c/hotjar-"+t._hjSettings.hjid+".js?sv="+t._hjSettings.hjsv,s.appendChild(n)}(window,document)</script>
<link rel="alternate" type="application/rss+xml" href="/docs/openziti/blog/rss.xml" title="OpenZiti RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/openziti/blog/atom.xml" title="OpenZiti Atom Feed">

<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var g=t.getElementsByTagName(a)[0],m=t.createElement(a);m.async=!0,m.src="https://www.googletagmanager.com/gtm.js?id=GTM-5SF399H3",g.parentNode.insertBefore(m,g)}(window,document,"script","dataLayer")</script>





<link rel="search" type="application/opensearchdescription+xml" title="OpenZiti" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.273075c6.css">
<script src="/assets/js/runtime~main.6236f723.js" defer="defer"></script>
<script src="/assets/js/main.d05d9df4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5SF399H3" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>



<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/ziti-logo-dark.svg"><link rel="preload" as="image" href="/img/ziti-logo-light.svg"><link rel="preload" as="image" href="https://avatars.githubusercontent.com/r-caamano"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/ziti-logo-dark.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/ziti-logo-light.svg" alt="The OpenZiti logo, an open source zero trust network overlay" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item"><a class="navbar__item navbar__link header-netfoundry-link" href="https://netfoundry.io/products/netfoundry-cloud-30-day-free-trial/" target="_blank">NetFoundry</a></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/openziti/learn/introduction/">Documentation</a><a class="navbar__item navbar__link" href="/docs/openziti/downloads">Downloads</a><div class="navbar__item"><a class="navbar__item navbar__link header-netfoundry-link" href="https://blog.openziti.io/" target="_blank">Blog</a></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li class=""><div class="text-divider"><p>Socials</p></div></li><li class=""><a href="https://www.youtube.com/OpenZiti" target="_blank" title="OpenZiti on YouTube"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/docs/openziti/img/yt.svg" alt="YouTube logo">YouTube</span></a></li><li class=""><a href="https://x.com/OpenZiti" target="_blank" title="OpenZiti on X(formerly Twitter)"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/docs/openziti/img/twit.svg" alt="X/Twitter logo">X (Twitter)</span></a></li><li class=""><a href="https://www.reddit.com/r/openziti" target="_blank" title="OpenZiti Subreddit"><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/docs/openziti/img/reddit-logo.png" alt="Reddit logo">Reddit</span></a></li><li class=""><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/docs/openziti/img/ziggy.png" alt="X/Twitter Ziggy logo"><a href="https://x.com/OpenZiggy" target="_blank" title="OpenZiggy on X(formerly Twitter)">Ziggy</a></span></li><li class=""><div class="text-divider"><p>Other</p></div></li><li class=""><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/docs/openziti/img/blog-icon.png" alt="OpenZiti blog logo"><a href="https://blog.openziti.io/" target="_blank" title="Blog">Blog</a></span></li><li class=""><span id="navbarDropdownItem"><img id="navbarDropdownImage" src="/docs/openziti/img/oz-test-kitchen.png" alt="OpenZiti Test Kitchen logo"><a href="https://github.com/openziti-test-kitchen" target="_blank" title="Git project for the test kitchen">Test Kitchen</a></span></li></ul></div><a href="https://openziti.discourse.group/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-discourse-link" title="Discourse"></a><a href="https://github.com/openziti/ziti" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" title="GitHub"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="styles-module_starUsRoot__hMNZp"><span style="color:whitesmoke">Star Us on GitHub<!-- --> </span><span style="height:20px"><span><a href="https://github.com/openziti/ziti" data-icon="octicon-star" data-show-count="true" aria-label="Star buttons/github-buttons on GitHub">Star</a></span></span></div><div class="main-wrapper NetFoundryLayout-module_ozLayoutMainWrapper__a2vwh"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/introducing-zrok-10">Introducing zrok 1.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-unleashed-top-10-uses-explored">zrok Unleashed: Top 10 Uses Explored</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/securing-ziti-identities-with-hsmtpm">Securing Ziti Identities with HSM/TPM</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-custom-domains">zrok Custom Domains</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/golang-aha-moments-oop">Golang Aha! Moments: OOP</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-safest-way-to-make-portainer-internet-accessible">The safest way to make Portainer Internet accessible</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/multifactor-zero-trust-ssh">Multifactor Zero Trust ssh</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zero-trust-sshclient">Zero Trust *ssh.Client</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/effortless-docker-management-with-private-web-access">Effortless Docker Management</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-is-growing-up">zrok is Growing Up</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-vpn-linux-service">Easy Steps to Install a Private VPN on Linux with zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/jitsi-meet-zrok">Jitsi, meet zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/extend-access-to-a-private-s3-bucket-using-python">Extend Access to a Private S3 Bucket Using Python</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/why-we-verify-github-commits">Why We Verify GitHub Commits</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/limitless-zrok-with-docker">Limitless zrok with Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/how-to-prevent-path-traversal-attacks-with-openziti-browzer">How to Prevent Path Traversal Attacks with OpenZiti BrowZer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-vpn">zrok VPN</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/deploy-openziti-in-kubernetes-with-ease-using-k3d">Deploy OpenZiti in Kubernetes with Ease Using k3d</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/signing-executables-from-github-actions">Signing Executables From GitHub Actions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-nodejs-zrok-sdk">The NodeJS zrok SDK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/no-listening-ports">No Listening Ports?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/announcing-openziti-v1">Announcing OpenZiti v1.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/pixy-dust-for-web-applications-pkce">Pixy Dust For Web Applications</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/secure-remote-development-with-zrok-and-jetbrains">Secure Remote Development with zrok and JetBrains</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-permission-modes">zrok Permission Modes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-zrok-socks-backend">The zrok SOCKS Backend</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-python-zrok-sdk">The Python zrok SDK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/securing-dedicated-palworld-server-with-zrok">Securing a Dedicated  Palworld Server For My Family with zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/fun-with-adaptive-rate-limiting">Fun with Adaptive Rate Limiting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-zrok-drives-cli-preview">The zrok Drives CLI Preview</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/minecraft-over-zrok">Minecraft Over zrok</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/go-is-amazing-for-zero-trust">Go is Amazing for Zero Trust</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-frontdoor">zrok frontdoor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/business-rule-driven-just-in-time-network-access">Business Rule Driven Just-in-Time Network Access</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-drives-an-early-preview">zrok Drives (an Early Preview)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/put-some-ziti-in-your-caddy">Put some Ziti in your Caddy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-zrok-oauth-public-frontend">The zrok OAuth Public Frontend</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/securing-azure-openai-applications-with-openziti">Securing Azure OpenAI Applications with OpenZiti</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/openziti-zero-trust-iot-wi-fi-gateway">OpenZiti Zero Trust IoT Wi-Fi Gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-with-the-power-of-caddy">zrok with the Power of Caddy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-zrok-sdk">The zrok SDK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/got-5-minutes-secure-your-python-website-with-zero-trust">Got 5 Minutes? Secure Your Python Website with Zero Trust.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/announcing-the-zrok-public-beta">Announcing the zrok Public Beta!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zrok-v040-released">zrok v0.4.0 Released!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/commercial-open-source-and-ethical-and-practical-community-engagement">Commercial Open Source and Ethical (and practical) Community Engagement</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/my-pi-day-journey-with-go-64-bit-alignment">My Pi Day Journey with Go 64-bit alignment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/private-dns-on-windows">Private DNS on Windows</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/websockets-over-zrok">Websockets over zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/openapi-python-clients">OpenAPI Python Clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/postman-mgmt">Postman and the Management API</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/the-road-ahead-for-zrok">The Road Ahead for zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/auto-complete">Ziti Shell Auto-Complete</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/introducing-zrok">Introducing zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/connecting-to-local-development-environment-from-cloud-hosts-with-zrok">Connecting to Local Development Environment from Cloud Hosts with zrok</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/lessons-learned-writing-a-zero-trust-nginx-module">Lessons Learned Writing a Zero Trust NGINX Module</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zero-trust-monitoring-with-openziti">Zero Trust Monitoring with OpenZiti</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/its-a-zitiful-life">It&#x27;s A Zitiful Life</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/nginx-zerotrust-api-security">NGINX &amp; ZeroTrust API Security</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/docs/openziti/blog/using-ebpf-tc-to-securely-mangle-packets-in-the-kernel-and-pass-them-to-my-secure-networking-application">Using eBPF-TC to securely mangle packets in the kernel, and pass them to my secure networking application</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/browzer-gateway-fqdn-certs">OpenZiti BrowZer Gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/openziti-authentication-api-integrations">OpenZiti Authentication API Integrations</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/high-level-publicprivate-cryptography">High-Level Public/Private Cryptography</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/set-up-a-secure-multiplayer-minecraft-server">Set Up a Secure Multiplayer Minecraft Server</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/setting-up-oracle-cloud-to-host-openziti">Setting Up Oracle Cloud To Host OpenZiti</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/integrating-ziti-is-easy">Integrating Ziti is Easy! How we got our app tested with go-httpbin</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/golang-aha-moments-generics">Golang Aha! Moments: Generics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/securing-nodejs-applications">Securing NodeJS Applications — An Introduction to the OpenZiti SDK for NodeJS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/openziti-is-participating-in-hacktoberfest-prost">OpenZiti is Participating in Hacktoberfest, Prost!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/openziti-python-sdk-introduction">OpenZiti Python SDK: Introduction</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/free-secure-access-to-nas-from-anywhere">Free Secure Access to NAS From Anywhere</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/introducing-openziti-browzer">Introducing OpenZiti BrowZer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/golang-aha-moments-channels">Golang Aha! Moments: Channels</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zero-trust-overlay-network-to-access-homeassistant">I Created a Zero Trust Overlay Network to Access HomeAssistant</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/my-intern-assignment-call-a-dark-webhook-from-aws-lambda">My Intern Assignment - Call a Dark Webhook from AWS Lambda</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/extrovert-wednesday">Extrovert Wednesday</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/securing-web-apis-with-openziti">Securing Web APIs With OpenZiti — Zero Trust For Web APIs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/tunneling-voip-over-openziti">Tunneling VoIP over OpenZiti</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/bootstrapping-trust-part-5-bootstrapping-trust">Bootstrapping Trust Part 5</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/bootstrapping-trust-part-4-certificate-authorities-chains-of-trust">Bootstrapping Trust Part 4</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/bootstrapping-trust-part-3-certificates">Bootstrapping Trust Part 3 - Certificates</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/bootstrapping-trust-part-2-a-primer-on-public-key-cryptography">Bootstrapping Trust Part 2 - PKI</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/bootstrapping-trust-part-1-encryption-everywhere">Bootstrapping Trust Part 1 - Encryption Everywhere</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/configuring-openziti-to-enable-prometheus">Configuring OpenZiti to Enable Prometheus</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/prometheus-scrape-anything-from-anywhere">Prometheus - Scrape Anything from Anywhere</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/scraping-anything-anywhere-in-action">Scraping Anything, Anywhere in Action</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/kubernetes">Tunneling Ingress to Kubernetes Workloads</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zitifying-scp">Zitifying SCP</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zitifying-ssh">Zitifying SSH</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/zitification">Zitification</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/openziti/blog/mobile-point-of-sale-mpos-app-ziti-android-java-sdk-integration">Mobile Point of Sale (mPOS) app – embed zero trust networking</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Using eBPF-TC to securely mangle packets in the kernel, and pass them to my secure networking application</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-11-09T22:10:42.000Z">November 9, 2022</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/r-caamano" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://avatars.githubusercontent.com/r-caamano" alt="Robert Caamano"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/r-caamano" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Robert Caamano</span></a></div><small class="authorTitle_nd0D" title="Author">Author</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p>eBPF enables you to safely run sandboxed programs for functions like security and networking in the OS kernel, without
changing kernel source code or loading kernel modules. eBPF-TC specifically has robust packet mangling capability, and
enables ingress and egress operations, with high performance.</p>
<p>This is how I used TC-eBPF to build a Plugin TPROXY Interception Firewall (IFW) to intercept and deliver packets to my target application - OpenZiti Edge Routers. You can use a similar eBPF-TC implementation to intercept packets to send to your specific observability, security or networking application. The code is here: <a href="https://github.com/netfoundry/zfw" target="_blank" rel="noopener noreferrer">https://github.com/netfoundry/zfw</a>. Process flow and packet flow diagrams are at the end of this article.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-context--passing-packets-to-openziti-endpoints">Project context – passing packets to OpenZiti endpoints<a href="#project-context--passing-packets-to-openziti-endpoints" class="hash-link" aria-label="Direct link to Project context – passing packets to OpenZiti endpoints" title="Direct link to Project context – passing packets to OpenZiti endpoints">​</a></h2>
<p>OpenZiti (open source zero trust networking platform) enables private connections across full mesh Internet overlay networks. Ziti endpoints are embedded in applications as code (via Ziti SDKs), and deployed as OS agents, daemons, containers or VMs. You can spin up any number of Ziti routers in your private mesh - it looks like this if you deploy two routers:</p>
<p><img decoding="async" loading="lazy" alt="OpenZiti End to End Encryption Terminating at the Routers" src="/assets/images/qJTZ9uPxE-7b244682c8554ae608cf648ab6b87cb1.png" width="2395" height="453" class="img_ev3q"></p>
<p>Ziti Edge Routers are often used on Linux and default to iptables to map incoming interesting traffic toward service listening ports using <a href="https://docs.kernel.org/networking/tproxy.html" target="_blank" rel="noopener noreferrer">IP Table Tproxy Target</a>. This works great if for example you are running Ubuntu and FWD. However, there are many Linux distros with key variances. I therefore used TC-eBPF to build a more universal option for Linux distros which support eBPF, enabling those distros to intercept traffic of interest. The eBPF feature set also enabled additional packet filtering and manipulation not natively supported in iptables/nftables.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tc-ebpf-ifw--tproxy-target-entries">TC-eBPF IFW – tproxy target entries<a href="#tc-ebpf-ifw--tproxy-target-entries" class="hash-link" aria-label="Direct link to TC-eBPF IFW – tproxy target entries" title="Direct link to TC-eBPF IFW – tproxy target entries">​</a></h2>
<p>So before diving into building the eBPF IFW I needed to reverse engineer how OpenZiti edge-routers natively translate services into iptables rules - which TPROXY target statements need to be added/deleted based on services the router learned from the OpenZiti Controller. The following is the information used to create the tproxy target entries via iptables.</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">IP Destination Prefix: Dotted Decimal IP/mask bit-length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TCP/UDP port range in the format Decimal Low_Port:High_Port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Protocol: TCP/UDP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TPROXY Listening port: Decimal port</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tc-ebpf-ifw--insertion-and-mapping">TC-eBPF IFW – insertion and mapping<a href="#tc-ebpf-ifw--insertion-and-mapping" class="hash-link" aria-label="Direct link to TC-eBPF IFW – insertion and mapping" title="Direct link to TC-eBPF IFW – insertion and mapping">​</a></h2>
<p>So now with this information I could start thinking about the eBPF map types and structures that I would use to communicate between a user space mapping tool and the IFW to dynamically update rules.</p>
<p>Since I wanted my program to act function similarly to ufw/iptables I chose TC-eBPF as my insertion point due to the combination of its attachment at the interface level (ability to drop packets before forwarding to the Linux IP stack), and the currently available sk helpers for socket lookup/splicing.</p>
<p>In order to check if an incoming packet matches an intercept policy created by a Ziti network administrator (Ziti intercepts specifically defined flows – doesn’t default to intercepting all flows), I needed a pinned map that supported a struct key type. A a eBPF hash map which allows for struct as a key gave me the flexibility to customize the lookup and add or delete criteria as use cases evolve. Using pinned maps allows multiple copies of the ebpf program to run (One on each inbound interface) and share the map updated by the mapping tool/Ziti.</p>
<p>Depicted below is the initial map definition I chose:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(type, BPF_MAP_TYPE_ARRAY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(id, BPF_MAP_ID_IFINDEX_IP);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(key_size, sizeof(uint32_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(value_size, sizeof(struct ifindex_ip4));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(max_entries, 50);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(pinning, LIBBPF_PIN_BY_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ifindex_ip_map SEC(&quot;.maps&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The initial key I chose a struct of the following form:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct tproxy_key {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __u32 dst_ip;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __u16 prefix_len;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __u16 protocol;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">These data structures allow for a lookup based on destination ip prefix, cidr length, and ip protocol(tcp/udp) which can all be decerned from the incoming packet. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For value I used a struct of the following format:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct tproxy_tuple {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   __u16 index_len; /*tracks the number of entries in the index_table*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   __u16 index_table[MAX_INDEX_ENTRIES];/* Array used as index table which points to    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Struct *tproxy_port_mapping in the     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port_maping array with each poulated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index representing a udp or tcp tproxy     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mapping in the port_mapping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct tproxy_port_mapping port_mapping[MAX_TABLE_SIZE];/* Array to store unique   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tproxy mappings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with each index match   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">the low_port of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct  tproxy_port_mapping{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u16 low_port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u16 high_port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u16 tproxy_port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u32 tproxy_ip;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Since OpenZiti IP based service policies can be defined at any level of granularity, including network CIDR blocks, I did not want to have to generate hash entries for every host address in contained in a block. I therefore implemented a longest match lookup algorithm that successively widens the mask checking to see if an incoming IP tuple either directly matches a host address or falls within a CIDR block range that matches the ip_dest / prefix_len fields in the tproxy_key along with matching IP transport protocol (TCP or UDP).</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct tproxy_tuple </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">tproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u32 exponent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* unsugend integer used to calulate prefix matches */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u32 mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xffffffff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* starting mask value used in prefix match calculation */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__u16 maxlen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* max number ip ipv4 prefixes */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__u16 count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> maxlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> count</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct tproxy_key key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">daddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> maxlen</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">protocol</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tproxy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_tproxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token maybe-class-name">Redacted</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> brevity</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*algorithm used to calucate mask while traversing each octet.*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00ffffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       exponent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0000ffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       exponent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x000000ff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       exponent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00000080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_SHOT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80ffffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exponent </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> exponent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0080ffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exponent </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> exponent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x000080ff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exponent </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> exponent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00000080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exponent </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> exponent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exponent</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Further, since a Ziti end user can associate any number of port ranges to a destination on a per protocol basis, in this first pass I did not want to create an entry in the hash map for every port given the potential for large port ranges i.e 1-65535. Instead, I created an index table in which each entry points to a populated array index in the port_mapping table where the index is the low_port value of the mapped rule. This limits the search for a port match to only populated port range entries vs sequential index searches directly in the port mapping table. I plan to test the performance and resource limitation of creating hash map entries for every member port vs indexed lookup of range start. Below is a code snippet of the lookup used to find a match based on the incoming tuple-&gt;ipv4.dport</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> max_entries</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* set port_key equal to the port value stored at current Index */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int port_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tproxy</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">index_table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">check if tuple destination port is greater than low port and lower than high    </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">port at mapping[port_key]</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">if matched get associated tproxy port and attempt to find listening socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">if successfull jump to assign:</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bpf_ntohs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpf_ntohs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tproxy</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">port_mapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">port_key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">low_port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bpf_ntohs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token function" style="color:#d73a49">bpf_ntohs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tproxy</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">port_mapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">port_key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">high_port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">               </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function maybe-class-name" style="color:#d73a49">If</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">local</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* if tuple-&gt;daddr == router’s ip then forward to stack */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_OK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/* construct tuple to used to lookup TPROXY sk */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         sockcheck</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">daddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tproxy</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">port_mapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">port_key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tproxy_ip</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         sockcheck</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dport</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tproxy</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">port_mapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">port_key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tproxy_port</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/* look up sk based on protocol in map key */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpf_skc_lookup_tcp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sockcheck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sockcheck</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ipv4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token constant" style="color:#36acaa">BPF_F_CURRENT_NETNS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             sk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpf_sk_lookup_udp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sockcheck</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sockcheck</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ipv4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token constant" style="color:#36acaa">BPF_F_CURRENT_NETNS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">sk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_SHOT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">protocol </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">IPPROTO_TCP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sk</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BPF_TCP_LISTEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token function" style="color:#d73a49">bpf_sk_release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_SHOT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         goto assign</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">assign</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*attempt to splice the skb to the tproxy or local socket*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpf_sk_assign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*release sk*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">//if succedded forward to the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_OK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*else drop packet if not running on loopback*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ingress_ifindex </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_OK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_SHOT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tc-ebpf--stateful-firewall">TC-eBPF – Stateful Firewall<a href="#tc-ebpf--stateful-firewall" class="hash-link" aria-label="Direct link to TC-eBPF – Stateful Firewall" title="Direct link to TC-eBPF – Stateful Firewall">​</a></h2>
<p>Since I wanted eBPF to perform the functionality of a stateful firewall (At least to the extent that there must be an active outbound session to a host for acknowledged packets to be accepted from that host), I needed to consider how to allow the program to manage session states for both UDP and TCP. I initially thought that this might be complicated. However, while working with the ebpf helpers used to splice sockets together, I realized that the same helpers could be used to check to see if an outgoing sockets had been initiated. In the case that an incoming packet tuple matched an existing outgoing session, splice the incoming skb to the existing sk while performing the same lookup that the program was already performing for the OpenAiti service tproxy sk(s). The following code excerpts shows the basic state inspection code I used for TCP:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* if tcp based tuple implement statefull inspection to see if they were</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">initiated by the local OS if not pass on to tproxy logic to determin if the OpenZiti router has tproxy </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">intercepts defined for the flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpf_skc_lookup_tcp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tuple</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tuple_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token constant" style="color:#36acaa">BPF_F_CURRENT_NETNS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sk</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BPF_TCP_LISTEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     goto assign</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">bpf_sk_release</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">assign</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*attempt to splice the skb to the tproxy or local socket*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bpf_sk_assign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*release sk*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">//if succeeded forward to the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_OK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*else drop packet if not running on loopback*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ingress_ifindex </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_OK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_SHOT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tc-ebpf-ifw--ssh-inbound">TC-eBPF IFW – SSH inbound<a href="#tc-ebpf-ifw--ssh-inbound" class="hash-link" aria-label="Direct link to TC-eBPF IFW – SSH inbound" title="Direct link to TC-eBPF IFW – SSH inbound">​</a></h2>
<p>Taking things, a step further I wanted to allow ssh inbound by default, but wanted to restrict ssh to only the IP address of the external interface which the eBPF program was attached. However, when running eBPF at the TC level you do not have access to the interface’s IP address. Having this functionality is essential to support ssh services over Ziti when using the standard port since the services would also have a destination port of TCP/22. So, without being able to discern the router’s IP, the program would not know whether to forward to the Linux stack or to Ziti Tproxy service ports. To solve this, I initially allow ssh to pass to any address, and then let my user space zfw app inform eBPF what its attached IP is via a bpf hash map. I did this by having the user space app use the ifindex as the hash map key and then then store the IP address in a struct with the IP Address array as one of its fields. Specifically, the map and structs I created are as follows:</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* hash Map */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(type, BPF_MAP_TYPE_HASH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(key_size, sizeof(uint32_t));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(value_size, sizeof(struct ifindex_ip4));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(max_entries, MAX_IF_ENTRIES);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(pinning, LIBBPF_PIN_BY_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __uint(map_flags, BPF_F_NO_PREALLOC);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ifindex_ip_map SEC(&quot;.maps&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*value to ifindex_ip_map*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct ifindex_ip4 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint32_t ipaddr[MAX_ADDRESSES];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char ifname[IFNAMSIZ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint8_t count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static inline struct ifindex_ip4 *get_local_ip4(__u32 key){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct ifindex_ip4 *ifip4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ifip4 = bpf_map_lookup_elem(&amp;ifindex_ip_map, &amp;key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return ifip4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*look up attached interface IP address*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct ifindex_ip4 *local_ip4 = get_local_ip4(skb-&gt;ingress_ifindex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* if ip of attached interface found in map only allow ssh to that IP */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(tcp &amp;&amp; (bpf_ntohs(tuple-&gt;ipv4.dport) == 22)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if((!local_ip4 || !local_ip4-&gt;count)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return TC_ACT_OK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }else{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uint8_t addresses = 0; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(local_ip4-&gt;count &lt; MAX_ADDRESSES){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addresses = local_ip4-&gt;count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }else{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addresses = MAX_ADDRESSES;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for(int x = 0; x &lt; addresses; x++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if((tuple-&gt;ipv4.daddr == local_ip4-&gt;ipaddr[x]) &amp;&amp; !local_diag-&gt;ssh_disable){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if(local_diag-&gt;verbose &amp;&amp; ((event.tstamp % 2) == 0)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        event.proto = IPPROTO_TCP;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        send_event(&amp;event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return TC_ACT_OK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre></div></div>
<p>UDP follows the same basic premise, but I needed to make an exception specifically for DHCP since it operates in a way that makes state inspection difficult (other stateful FWs like UFW also make the same inbound exception)</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* forward DHCP messages to local system */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">udp </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bpf_ntohs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">67</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">bpf_ntohs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tuple</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ipv4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">68</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TC_ACT_OK</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ebpf-user-space-integration">eBPF User Space Integration<a href="#ebpf-user-space-integration" class="hash-link" aria-label="Direct link to eBPF User Space Integration" title="Direct link to eBPF User Space Integration">​</a></h2>
<p>I created a user space app zfw.c which updates the pinned maps described earlier. The zfw populates the ip address / name of the interface with the attached eBPF program and inserts/deletes rules into/ffrom the nf_tproxy_map with the usage following patterns:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">Usage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sudo zfw </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">I</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip dest address or prefix</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">dst prefix len</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip src address or prefix</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">src prefix len</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p tcp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">dst low port</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">h </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">dst high port</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">tproxy port</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip protocol</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> sudo zfw </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">I</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token number" style="color:#36acaa">172.16</span><span class="token number" style="color:#36acaa">.240</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m </span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o </span><span class="token number" style="color:#36acaa">10.1</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token number" style="color:#36acaa">32</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p tcp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">h </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Usage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> sudo zfw </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">D</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip dest address or prefix</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">dst prefix len</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip src address or prefix</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">src prefix len</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p tcp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">dst low port</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">h </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">dst high port</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">tproxy port</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ip protocol</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> sudo zfw </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">D</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token number" style="color:#36acaa">172.16</span><span class="token number" style="color:#36acaa">.240</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m </span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">o </span><span class="token number" style="color:#36acaa">10.1</span><span class="token number" style="color:#36acaa">.1</span><span class="token number" style="color:#36acaa">.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">n </span><span class="token number" style="color:#36acaa">32</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p tcp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">l </span><span class="token number" style="color:#36acaa">22</span><br></span></code></pre></div></div>
<p>If you run an OpenZiti Router in diverter mode it will dynamically update the pinned BPF zt_tproxy_map used by the IFW to make forwarding decisions. The system calls are made dynamically whenever changes are made to any service either to add or delete them when running an OpenZiti edge-router in diverter mode.</p>
<p>The following shows the logging output from the edge-router running in diverter mode when initially learning services from the Ziti controller. You can see that it makes system calls to the zfw user space program to add the learned services as hash map entries into the bpf map.</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">Feb</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">21</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> ebpf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">router ziti</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">router</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">30284</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;command&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;/opt/openziti/bin/zfw -I -c 100.72.0.4 -m 32 -p tcp -l 5985 -h 5985 -t 43321&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;file&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;/home/ziggy/gitnfnew/ziti/tunnel/intercept/tproxy/tproxy_linux.go:546&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;func&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;github.com/openziti/ziti/tunnel/intercept/tproxy.(*tProxy).addInterceptAddr&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;diverter command succeeded. output: Adding TCP mapping\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;2024-02-24T20:21:32.420Z&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Feb</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">21</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> ebpf</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">router ziti</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">router</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">30284</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;command&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;/opt/openziti/bin/zfw -I -c 100.72.0.4 -m 32 -p tcp -l 22 -h 22 -t 43321&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;file&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;/home/ziggy/gitnfnew/ziti/tunnel/intercept/tproxy/tproxy_linux.go:546&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;func&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;github.com/openziti/ziti/tunnel/intercept/tproxy.(*tProxy).addInterceptAddr&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;diverter command succeeded. output: Adding TCP mapping\nlookup success\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;2024-02-24T20:21:32.426Z&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tc-ebpf-ifw--process-and-packet-flow-diagrams">TC-eBPF IFW – process and packet flow diagrams<a href="#tc-ebpf-ifw--process-and-packet-flow-diagrams" class="hash-link" aria-label="Direct link to TC-eBPF IFW – process and packet flow diagrams" title="Direct link to TC-eBPF IFW – process and packet flow diagrams">​</a></h2>
<p><img decoding="async" loading="lazy" alt="TC-eBPF IFW – process diagram" src="/assets/images/6LzUjyxVe-4baeb5ce3e80d68b32c2712bc00cd3e4.jpg" width="2198" height="1950" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="TC-eBPF IFW – packet flow diagram" src="/assets/images/DlMW3rsU9-2890255b7ae2425e6f53163307329079.jpg" width="2328" height="1754" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>This article described how I leveraged eBPF-TC to build a Plugin TPROXY IFW to steer traffic to my target application. Hopefully you found the experience that I shared useful. Would love to hear how other eBPF developers are making use of this robust functionality.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" title="Open Source content" class="tag_zVej tagRegular_sFm0" href="/docs/openziti/blog/tags/opensource">Open Source</a></li><li class="tag_QGVx"><a rel="tag" title="Firewall technologies" class="tag_zVej tagRegular_sFm0" href="/docs/openziti/blog/tags/firewall">Firewall</a></li><li class="tag_QGVx"><a rel="tag" title="OpenZiti related content" class="tag_zVej tagRegular_sFm0" href="/docs/openziti/blog/tags/openziti">OpenZiti</a></li><li class="tag_QGVx"><a rel="tag" title="eBPF tech" class="tag_zVej tagRegular_sFm0" href="/docs/openziti/blog/tags/ebpf">eBPF</a></li><li class="tag_QGVx"><a rel="tag" title="Linux tc" class="tag_zVej tagRegular_sFm0" href="/docs/openziti/blog/tags/tc">tc</a></li><li class="tag_QGVx"><a rel="tag" title="Transparent proxy" class="tag_zVej tagRegular_sFm0" href="/docs/openziti/blog/tags/tproxy">TProxy</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/openziti/blog/nginx-zerotrust-api-security"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">NGINX &amp; ZeroTrust API Security</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/openziti/blog/browzer-gateway-fqdn-certs"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">OpenZiti BrowZer Gateway</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#project-context--passing-packets-to-openziti-endpoints" class="table-of-contents__link toc-highlight">Project context – passing packets to OpenZiti endpoints</a></li><li><a href="#tc-ebpf-ifw--tproxy-target-entries" class="table-of-contents__link toc-highlight">TC-eBPF IFW – tproxy target entries</a></li><li><a href="#tc-ebpf-ifw--insertion-and-mapping" class="table-of-contents__link toc-highlight">TC-eBPF IFW – insertion and mapping</a></li><li><a href="#tc-ebpf--stateful-firewall" class="table-of-contents__link toc-highlight">TC-eBPF – Stateful Firewall</a></li><li><a href="#tc-ebpf-ifw--ssh-inbound" class="table-of-contents__link toc-highlight">TC-eBPF IFW – SSH inbound</a></li><li><a href="#ebpf-user-space-integration" class="table-of-contents__link toc-highlight">eBPF User Space Integration</a></li><li><a href="#tc-ebpf-ifw--process-and-packet-flow-diagrams" class="table-of-contents__link toc-highlight">TC-eBPF IFW – process and packet flow diagrams</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div><footer class="styles-module_ozFooter__vHkQA"><section class="styles-module_footer__Qk0iB styles-module_ozHorizontalSectionRoot__QwWz0 styles-module_ozhsContent__haNeV"><div class="styles-module_footerContainer__azQkg"><div class="styles-module_footerGrid__fsf9C"><div class="styles-module_footerColumn__tK2bv"><h3>NetFoundry</h3><p>An open source project enabling developers to embed zero trust networking directly into applications.</p><div class="styles-module_footerSocialLinks__b1FcV"><a href="https://github.com/openziti/ziti" target="_blank" class="styles-module_footerSocialLink__iAElV" rel="noreferrer"><svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"></path></svg></a><a href="https://www.linkedin.com/in/netfoundry/" target="_blank" class="styles-module_footerSocialLink__iAElV" rel="noreferrer"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.996 16V10.1C15.996 7.5 15.375 5.49999 12.025 5.49999C10.4 5.49999 9.325 6.39999 8.875 7.29999H8.825V5.79999H5.65V16H8.95V10.7C8.95 9.30001 9.2 7.9 10.925 7.9C12.65 7.9 12.675 9.59999 12.675 10.8V16H15.996Z"></path><path d="M0.25 5.79999H3.575V16H0.25V5.79999Z"></path><path d="M1.9 0C0.85 0 0 0.85 0 1.9C0 2.95 0.85 3.8 1.9 3.8C2.95 3.8 3.8 2.95 3.8 1.9C3.8 0.85 2.95 0 1.9 0Z"></path></svg></a><a href="https://youtube.com/openziti/" target="_blank" class="styles-module_footerSocialLink__iAElV" rel="noreferrer"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.969 4.69c-.183-1.358-1.062-2.275-2.361-2.46C12.371 2 8 2 8 2S3.629 2 2.362 2.229c-1.3.186-2.179 1.103-2.361 2.461C0 6.03 0 10 0 10s0 3.97.2 5.31c.183 1.358 1.062 2.275 2.361 2.46C3.63 18 8 18 8 18s4.371 0 5.638-.23c1.3-.185 2.178-1.102 2.361-2.46.2-1.34.2-5.31.2-5.31s0-3.97-.23-5.31zm-8.36, 8.57V6.73l3.76 2.27-3.76 2.26z"></path></svg></a><a href="https://twitter.com/openziti/" target="_blank" class="styles-module_footerSocialLink__iAElV" rel="noreferrer"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.996 3.038c-.59.262-1.219.44-1.885.52.677-.406 1.194-1.05 1.438-1.815-.634.375-1.337.648-2.085.795-.598-.638-1.45-1.038-2.396-1.038-1.813 0-3.283 1.469-3.283 3.282 0 .257.03.507.085.748-2.728-.137-5.147-1.445-6.766-3.43-.282.485-.444 1.05-.444 1.651 0 1.14.58 2.143 1.46 2.732-.538-.017-1.044-.164-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.219-.276.075-.567.116-.866.116-.211 0-.416-.021-.617-.06.418 1.304 1.63 2.254 3.066 2.28-1.124.883-2.539 1.406-4.077 1.406-.265 0-.526-.015-.785-.046 1.453.933 3.178 1.475 5.032 1.475 6.038 0 9.34-5.002 9.34-9.34 0-.142-.004-.284-.01-.425.641-.463 1.198-1.039 1.638-1.696"></path></svg></a></div></div><div class="styles-module_footerColumn__tK2bv"><h3>Community</h3><ul class="styles-module_footerLinks__eOmJ9"><li><a href="https://github.com/openziti/ziti">GitHub</a></li><li><a href="https://openziti.discourse.group/">Discourse Forum</a></li><li><a href="/docs/openziti/policies/CONTRIBUTING">Contributing</a></li></ul></div><div class="styles-module_footerColumn__tK2bv"><h3>Resources</h3><ul class="styles-module_footerLinks__eOmJ9"><li><a href="https://blog.openziti.io">OpenZiti Tech Blog</a></li><li><a href="https://netfoundry.io/">NetFoundry</a></li></ul></div></div></div><div class="styles-module_footerCopyright__nWyvc"><p>© 2025 NetFoundry Inc. OpenZiti is an open source project sponsored by NetFoundry. All rights reserved.</p></div></section></footer></div></div>
</body>
</html>