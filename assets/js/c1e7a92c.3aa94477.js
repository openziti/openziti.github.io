"use strict";(self.webpackChunkdocusaurus_3=self.webpackChunkdocusaurus_3||[]).push([[1440],{13518:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"reference/tunnelers/linux/linux-tunnel-troubleshooting","title":"Troubleshooting","description":"DNS Not Working","source":"@site/docs/reference/tunnelers/60-linux/50-linux-tunnel-troubleshooting.mdx","sourceDirName":"reference/tunnelers/60-linux","slug":"/reference/tunnelers/linux/linux-tunnel-troubleshooting","permalink":"/docs/reference/tunnelers/linux/linux-tunnel-troubleshooting","draft":false,"unlisted":false,"editUrl":"https://github.com/openziti/ziti-doc/tree/main/docusaurus/docs/reference/tunnelers/60-linux/50-linux-tunnel-troubleshooting.mdx","tags":[],"version":"current","lastUpdatedAt":1751143015000,"sidebarPosition":50,"frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Options and Modes","permalink":"/docs/reference/tunnelers/linux/linux-tunnel-options"},"next":{"title":"Docker","permalink":"/docs/reference/tunnelers/docker/"}}');var s=t(74848),i=t(28453),o=t(11503);const l={},c="Troubleshooting",a={},d=[{value:"DNS Not Working",id:"dns-not-working",level:2},...o.RM,{value:"Increase Log Level",id:"increase-log-level",level:2},{value:"Capture the Current Process Log",id:"capture-the-current-process-log",level:2},{value:"Systemd Service Won&#39;t Start or Keeps Restarting",id:"systemd-service-wont-start-or-keeps-restarting",level:2},{value:"Intercepting or Hosting Not Working",id:"intercepting-or-hosting-not-working",level:2},{value:"Process Keeps Crashing",id:"process-keeps-crashing",level:2},{value:"Operation Not Permitted",id:"operation-not-permitted",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"troubleshooting",children:"Troubleshooting"})}),"\n",(0,s.jsx)(n.h2,{id:"dns-not-working",children:"DNS Not Working"}),"\n",(0,s.jsx)(o.Ay,{}),"\n",(0,s.jsx)(n.h2,{id:"increase-log-level",children:"Increase Log Level"}),"\n",(0,s.jsx)(n.p,{children:"Set the log level to DEBUG to identify the activity that is occurring at the same time as the problem."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'# set the logLevel to "debug" in /opt/openziti/etc/ziti-edge-tunnel/config.json\nsudo -u ziti ziti-edge-tunnel set_log_level --loglevel DEBUG\n'})}),"\n",(0,s.jsx)(n.h2,{id:"capture-the-current-process-log",children:"Capture the Current Process Log"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"journalctl _SYSTEMD_INVOCATION_ID=$(systemctl show -p InvocationID --value ziti-edge-tunnel.service) -l \\\n| tee /tmp/ziti-edge-tunnel.log\n"})}),"\n",(0,s.jsx)(n.h2,{id:"systemd-service-wont-start-or-keeps-restarting",children:"Systemd Service Won't Start or Keeps Restarting"}),"\n",(0,s.jsx)(n.p,{children:"Reload the systemd service unit definitions to rule out a stale definition."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"sudo systemctl daemon-reload\n"})}),"\n",(0,s.jsx)(n.p,{children:"Inspect the service unit."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"sudo systemctl cat ziti-edge-tunnel.service\n"})}),"\n",(0,s.jsx)(n.p,{children:"Check the service status for events."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"sudo systemctl status ziti-edge-tunnel.service\n"})}),"\n",(0,s.jsx)(n.p,{children:"Monitor the service logs."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"sudo journalctl -u ziti-edge-tunnel.service\n"})}),"\n",(0,s.jsx)(n.p,{children:"Edit the service unit."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"sudo systemctl edit ziti-edge-tunnel.service\n"})}),"\n",(0,s.jsx)(n.h2,{id:"intercepting-or-hosting-not-working",children:"Intercepting or Hosting Not Working"}),"\n",(0,s.jsxs)(n.p,{children:["Inspect the identity and router info for a running tunneler process. This creates a file named like ",(0,s.jsx)(n.code,{children:"{{identity name}}.ziti"}),"\nfor each loaded identity. Each file summarizes the available services and router connections for the identity."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"sudo -u ziti ziti-edge-tunnel dump -p /tmp/ziti-dump-dir/\n"})}),"\n",(0,s.jsx)(n.p,{children:"Find tunneler's nameserver IP."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"$ resolvectl --interface=ziti0 dns\nLink 19 (tun0): 100.64.0.2\n"})}),"\n",(0,s.jsx)(n.p,{children:"Query the Ziti nameserver to find the intercept IP address for a service."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"dig +noall +answer my.ziti.service.example.com @100.64.0.2\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-buttonless",metastring:'title="Output"',children:"my.ziti.service.example.com. 60 IN    A       100.64.0.3\n"})}),"\n",(0,s.jsx)(n.p,{children:"The tunneler provides end-to-end TCP handshake. Test the service's ability to accept connections even if it does not\nprovide a greeting or banner as shown in the OpenSSH server example below."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"# wait up to 3 seconds for a TCP handshake on port 443\n$ ncat -vzw3 100.64.0.3 443\nNcat: Connected to 100.64.0.3:443.\nNcat: 0 bytes sent, 0 bytes received in 0.08 seconds.\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"# wait up to 3 seconds for an OpenSSH server greeting on port 22\n$ ncat -vw3 100.64.0.3 22\nSSH-2.0-OpenSSH_7.4\n"})}),"\n",(0,s.jsx)(n.h2,{id:"process-keeps-crashing",children:"Process Keeps Crashing"}),"\n",(0,s.jsxs)(n.p,{children:["A crash may be caused by a segmentation fault. If saving a Corefile is enabled, Linux will create a core dump file\naccording to this pattern file: ",(0,s.jsx)(n.code,{children:"/proc/sys/kernel/core_pattern"}),". Ubuntu configures this to use\n",(0,s.jsx)(n.a,{href:"https://wiki.ubuntu.com/Apport",children:"Apport"}),". Read more about ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Core_dump",children:"core dumps"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Please raise ",(0,s.jsx)(n.a,{href:"https://github.com/openziti/ziti-tunnel-sdk-c/issues/",children:"a GitHub issue"})," if the tunneler crashes."]}),"\n",(0,s.jsx)(n.h2,{id:"operation-not-permitted",children:"Operation Not Permitted"}),"\n",(0,s.jsxs)(n.p,{children:["Deleting the ",(0,s.jsx)(n.code,{children:"/tmp/.ziti"})," directory and restarting the tunneler may solve this issue if the tunneler was previously run as root."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"WARN ziti-edge-tunnel:ziti-edge-tunnel.c:1686 make_socket_path() failed to set ownership of /tmp/.ziti to 1003:1003: Operation not permitted (errno=1)\nWARN ziti-edge-tunnel:ziti-edge-tunnel.c:1730 run_tunneler_loop() One or more socket servers did not properly start.\n"})}),"\n",(0,s.jsx)(n.p,{children:"Another symptom of the same issue is this error when attempting to send a message to the IPC socket server, which is not running."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"failed to connect: -111/connection refused\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},11503:(e,n,t)=>{t.d(n,{Ay:()=>l,RM:()=>i});var r=t(74848),s=t(28453);const i=[];function o(e){const n={code:"code",em:"em",p:"p",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ziti-edge-tunnel run"})," provides a built-in nameserver for the services it is authorized to dial. The nameserver is automatically configured by ",(0,r.jsx)(n.code,{children:"systemd-resolved"}),", if enabled."]}),"\n",(0,r.jsxs)(n.p,{children:["If ",(0,r.jsx)(n.code,{children:"systemd-resolved"})," is not enabled, you must configure your resolver to query the tunneler's nameserver. Add Ziti's nameserver to the connection manager, e.g., NetworkManager, Netplan, or by directly editing ",(0,r.jsx)(n.code,{children:"/etc/resolv.conf"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"You may configure the system resolver to use the tunneler's nameserver as the first or only nameserver."}),"\n",(0,r.jsxs)(n.p,{children:["When the tunneler nameserver is the first of multiple nameservers and the requested DNS record does not match an authorized service's intercept domain name, it sets the query status to ",(0,r.jsx)(n.code,{children:"REFUSE"}),". This implies that the caller ",(0,r.jsx)(n.em,{children:"should"})," keep trying to resolve the domain name with other nameservers."]}),"\n",(0,r.jsxs)(n.p,{children:["To use the tunneler nameserver as the only nameserver, you must specify an upstream nameserver for recursion: ",(0,r.jsx)(n.code,{children:"ziti-edge-tunnel run --dns-upstream 208.67.222.222"}),". In this configuration, the query status from the upstream nameserver is returned, e.g., ",(0,r.jsx)(n.code,{children:"NXDOMAIN"})," if the domain name is not found in the tunneler nameserver or the upstream nameserver."]}),"\n",(0,r.jsxs)(n.p,{children:["The IP address of the nameserver (default: ",(0,r.jsx)(n.code,{children:"100.64.0.2"}),") is determined by the tunneler's dns-ip-range (default: ",(0,r.jsx)(n.code,{children:"100.64.0.1/10"}),")."]})]})}function l(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var r=t(96540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);