"use strict";(self.webpackChunkdocusaurus_3=self.webpackChunkdocusaurus_3||[]).push([[84478],{16636:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>c});var t=n(85480),s=n(74848),r=n(28453);const o={title:"Securing Ziti Identities with HSM/TPM",date:new Date("2025-02-26T15:27:28.000Z"),cuid:"cm7m2kag7000009l5ahicajw9",slug:"securing-ziti-identities-with-hsmtpm",authors:["EugeneKobyakov"],image:"@site/blogs/openziti/v1740433372226/36a74b0f-3dfc-496f-8907-00e6fb0aabfd.jpeg",imageDark:"@site/blogs/openziti/v1740433372226/36a74b0f-3dfc-496f-8907-00e6fb0aabfd.jpeg",tags:["security","hardware","zerotrust","hsm","tpm"]},l=void 0,a={authorsImageUrls:[void 0]},c=[{value:"This is How I (en)Roll",id:"this-is-how-i-enroll",level:2}];function d(e){const i={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.p,{children:"Regular readers of this blog know that OpenZiti provides secure overlay networking between Ziti identities.\nYou can improve security of your OpenZiti edge identities by using hardware-based private keys.\nThis guide provides step-by-step instructions on integrating hardware security with OpenZiti.\nIt uses Linux built-in TPM as a hardware security device. Similar steps will also work with other HSM devices."}),"\n",(0,s.jsx)(i.h2,{id:"this-is-how-i-enroll",children:"This is How I (en)Roll"}),"\n",(0,s.jsx)(i.p,{children:"On my Linux(Ubuntu) laptop I check that the kernel detected TPM hardware and created a device for it."}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"ziggy@hermes:~$ ls -l /dev/tpm*\ncrw-rw---- 1 tss root  10,   224 Apr 26 14:41 /dev/tpm0\ncrw-rw---- 1 tss tss  253, 65536 Apr 26 14:41 /dev/tpmrm0\n"})}),"\n",(0,s.jsxs)(i.p,{children:["Device ",(0,s.jsx)(i.code,{children:"/dev/tpmrm0"})," is there, so I can proceed."]}),"\n",(0,s.jsxs)(i.p,{children:["Add my user to the ",(0,s.jsx)(i.code,{children:"tss"})," group so that the TPM device can be accessed. You will probably need to restart your login shell for that to take effect, check your groups with ",(0,s.jsx)(i.code,{children:"id"})," command."]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"ziggy@hermes:~$ sudo usermod -G tss -a ziggy\n"})}),"\n",(0,s.jsx)(i.p,{children:"Install some useful software packages to interact with the TPM device"}),"\n",(0,s.jsxs)(i.ul,{children:["\n",(0,s.jsxs)(i.li,{children:["\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.code,{children:"libtpm2-pkcs11-tools"})," - includes ",(0,s.jsx)(i.code,{children:"tmp2_ptool"})," to initialize PKCS#11 token on TPM device"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:["\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.code,{children:"libtpm2-pkcs11-1"})," - TPM PKCS#11 library"]}),"\n"]}),"\n",(0,s.jsxs)(i.li,{children:["\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.code,{children:"opensc"})," - includes ",(0,s.jsx)(i.code,{children:"pkcs11-tool"})," for interacting with PKCS#11 token. This is not needed for OpenZiti enrollment but is useful for inspecting tokens"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"ziggy@hermes:~$ sudo apt install libtpm2-pkcs11-tools libtpm2-pkcs11-1 opensc\n"})}),"\n",(0,s.jsx)(i.p,{children:"Now that I have access to the device and the needed software I can initialize the token and test PKCS#11 driver access to it"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"ziggy@hermes:~$ tpm2_ptool init\naction: Created\nid: 1\n\nziggy@hermes:~$ tpm2_ptool addtoken --pid 1 --sopin 1111 --userpin ziggy1 --label ziggy-tpm\n\nziggy@hermes:~/ziti$ pkcs11-tool --module /usr/lib/x86_64-linux-gnu/pkcs11/libtpm2_pkcs11.so --list-slots\nWARNING: Getting tokens from fapi backend failed.\nAvailable slots:\nSlot 0 (0x1): ziggy-tpm\n  token label        : ziggy-tpm\n  token manufacturer : Infineon\n  token model        : SLB9665\n  token flags        : login required, rng, token initialized, PIN initialized\n  hardware version   : 1.16\n  firmware version   : 5.62\n  serial num         : 0000000000000000\n  pin min/max        : 0/128\nSlot 1 (0x2): \n  token state:   uninitialized\n"})}),"\n",(0,s.jsxs)(i.p,{children:["Note: fapi backend warning can be ",(0,s.jsx)(i.a,{href:"https://github.com/tpm2-software/tpm2-pkcs11/issues/655#issuecomment-781500908",children:"ignored"}),"."]}),"\n",(0,s.jsxs)(i.p,{children:["To enroll I need to get an enrollment token from my Ziti controller. Once I have that I can enroll. Let\u2019s enroll with ",(0,s.jsx)(i.code,{children:"ziti-edge-tunnel"})]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"\n# enroll identity with ziti-edge-tunnel\nziggy@hermes:~$ ziti-edge-tunnel enroll -j ./ziggy.jwt -i ziggy.json -k 'pkcs11:///usr/lib/x86_64-linux-gnu/pkcs11/libtpm2_pkcs11.so?label=ziggy-key&pin=ziggy1'\n(1676722)[        0.000]    INFO ziti-sdk:utils.c:198 ziti_log_set_level() set log level: root=3/INFO\n(1676722)[        0.000]    INFO ziti-sdk:utils.c:167 ziti_log_init() Ziti C SDK version 1.5.0 @ga39db85(HEAD) starting at (2025-02-24T15:21:31.292)\n(1676722)[        0.000]    INFO ziti-sdk:ziti_enroll.c:112 ziti_enroll() Ziti C SDK version 1.5.0 @ga39db85(HEAD) starting enrollment at (2025-02-24T15:21:31.294)\n(1676722)[        0.000]    INFO ziti-sdk:ziti_enroll.c:221 start_enrollment() pkcs11 key not found. trying to generate\n"})}),"\n",(0,s.jsxs)(i.p,{children:["ZIti identity is stores in the JSON file -- ",(0,s.jsx)(i.code,{children:"ziggy.json"})," in my case. Let take a look"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-json",children:'{\n  "ztAPI": "https://<my-controller-address>:443",\n  "id": {\n    "cert": "-----BEGIN CERTIFICATE-----....",\n    "key": "pkcs11:///usr/lib/x86_64-linux-gnu/libtpm2_pkcs11.so?label=ziggy-key&pin=ziggy1",\n    "ca": "-----BEGIN CERTIFICATE-----...."\n   }\n}\n'})}),"\n",(0,s.jsxs)(i.p,{children:["As you can see the .id.key is referencing the private key stored in my laptop's TPM hardware. I can inspect it using ",(0,s.jsx)(i.code,{children:"pkcs11-tool"})]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-bash",children:"ziggy@hermes:~$ pkcs11-tool --module /usr/lib/x86_64-linux-gnu/pkcs11/libtpm2_pkcs11.so --list-objects --pin ziggy1          1 \u21b5\nUsing slot 0 with a present token (0x1)\nPublic Key Object; EC  EC_POINT 384 bits\n  EC_POINT:   04610442fa885e120e9c63227aa7c53aeb84a52400264f3452fcf4dc4dbf4ade9ca46e7e15c4d37cc7a317edd860887ccd5746eea70cdea1d106b36b59297ecb93d43c57f4e8aef7029fa55f52cd740292d8de92fbce35c7788d3cc00f528cac2d0e4d\n  EC_PARAMS:  06052b81040022 (OID 1.3.132.0.34)\n  label:      ziggy-key\n  ID:         dad9d0f20cc1d9ec\n  Usage:      encrypt, verify, wrap\n  Access:     local\nPrivate Key Object; EC\n  label:      ziggy-key\n  ID:         dad9d0f20cc1d9ec\n  Usage:      decrypt, sign, unwrap\n  Access:     sensitive, always sensitive, never extractable, local\n  Allowed mechanisms: ECDSA,ECDSA-SHA1,ECDSA-SHA256,ECDSA-SHA384,ECDSA-SHA512\n"})}),"\n",(0,s.jsxs)(i.p,{children:["As you can see my TPM token ",(0,s.jsx)(i.code,{children:"ziggy-tpm"})," now has two objects private, and public keys with same label and id. OpenZiti SDK will use that hardware key to provide identity."]}),"\n",(0,s.jsxs)(i.p,{children:["Now I can start ",(0,s.jsx)(i.code,{children:"ziti-edge-tunnel"})," with that identity:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-plaintext",children:"ziggy@hermes:~$ sudo -E ziti-edge-tunnel run -i ziggy.json\n"})}),"\n",(0,s.jsxs)(i.p,{children:["Note: ",(0,s.jsx)(i.code,{children:"-E"})," flag is required since I initialized TPM token as user ",(0,s.jsx)(i.code,{children:"ziggy"})," and there are some support files created in the user\u2019s ",(0,s.jsx)(i.code,{children:"$HOME"})," directory."]})]})}function p(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>o,x:()=>l});var t=n(96540);const s={},r=t.createContext(s);function o(e){const i=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:i},e.children)}},85480:e=>{e.exports=JSON.parse('{"permalink":"/docs/openziti/blog/securing-ziti-identities-with-hsmtpm","source":"@site/blog/securing-ziti-identities-with-hsm-tpm.md","title":"Securing Ziti Identities with HSM/TPM","description":"Regular readers of this blog know that OpenZiti provides secure overlay networking between Ziti identities.","date":"2025-02-26T15:27:28.000Z","tags":[{"inline":false,"label":"Security","permalink":"/docs/openziti/blog/tags/security","description":"Security-related posts"},{"inline":false,"label":"Hardware","permalink":"/docs/openziti/blog/tags/hardware","description":"Hardware-related content"},{"inline":false,"label":"Zero Trust","permalink":"/docs/openziti/blog/tags/zerotrust","description":"Zero Trust Networking"},{"inline":false,"label":"HSM","permalink":"/docs/openziti/blog/tags/hsm","description":"Hardware Security Modules"},{"inline":false,"label":"TPM","permalink":"/docs/openziti/blog/tags/tpm","description":"Trusted Platform Module"}],"readingTime":3.66,"hasTruncateMarker":true,"authors":[{"name":"Eugene Kobyakov","title":"Author","url":"https://github.com/ekoby","imageURL":"https://avatars.githubusercontent.com/ekoby","key":"EugeneKobyakov","page":null}],"frontMatter":{"title":"Securing Ziti Identities with HSM/TPM","date":"2025-02-26T15:27:28.000Z","cuid":"cm7m2kag7000009l5ahicajw9","slug":"securing-ziti-identities-with-hsmtpm","authors":["EugeneKobyakov"],"image":"@site/blogs/openziti/v1740433372226/36a74b0f-3dfc-496f-8907-00e6fb0aabfd.jpeg","imageDark":"@site/blogs/openziti/v1740433372226/36a74b0f-3dfc-496f-8907-00e6fb0aabfd.jpeg","tags":["security","hardware","zerotrust","hsm","tpm"]},"unlisted":false,"prevItem":{"title":"zrok Unleashed: Top 10 Uses Explored","permalink":"/docs/openziti/blog/zrok-unleashed-top-10-uses-explored"},"nextItem":{"title":"zrok Custom Domains","permalink":"/docs/openziti/blog/zrok-custom-domains"}}')}}]);