"use strict";(self.webpackChunkdocusaurus_3=self.webpackChunkdocusaurus_3||[]).push([[5013],{93474:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"reference/ha/bootstrapping/certificates","title":"Controller Certificates","description":"For controllers to communicate and trust one another, they need certificates that have","source":"@site/docs/reference/ha/bootstrapping/certificates.md","sourceDirName":"reference/ha/bootstrapping","slug":"/reference/ha/bootstrapping/certificates","permalink":"/docs/reference/ha/bootstrapping/certificates","draft":false,"unlisted":false,"editUrl":"https://github.com/openziti/ziti-doc/tree/main/docusaurus/docs/reference/ha/bootstrapping/certificates.md","tags":[],"version":"current","lastUpdatedAt":1746107205000,"sidebarPosition":20,"frontMatter":{"sidebar_label":"Certificates","sidebar_position":20},"sidebar":"docsSidebar","previous":{"title":"Overview","permalink":"/docs/reference/ha/bootstrapping/overview"},"next":{"title":"Configuration","permalink":"/docs/reference/ha/bootstrapping/configuration"}}');var n=i(74848),o=i(28453);const c={sidebar_label:"Certificates",sidebar_position:20},s="Controller Certificates",a={},l=[{value:"Glossary",id:"glossary",level:2},{value:"SPIFFE ID",id:"spiffe-id",level:3},{value:"Trust domain",id:"trust-domain",level:3},{value:"Requirements",id:"requirements",level:2},{value:"Steps to Certificate Creation",id:"steps-to-certificate-creation",level:2},{value:"Example",id:"example",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"controller-certificates",children:"Controller Certificates"})}),"\n",(0,n.jsx)(t.p,{children:"For controllers to communicate and trust one another, they need certificates that have\nbeen generated with the correct attributes and relationships."}),"\n",(0,n.jsx)(t.h2,{id:"glossary",children:"Glossary"}),"\n",(0,n.jsx)(t.h3,{id:"spiffe-id",children:"SPIFFE ID"}),"\n",(0,n.jsx)(t.p,{children:"A SPIFFE ID is a specially formatted URI which is intended to be embedded in a certificates. Applications\nuse these identifiers to figure out the following about the applications connecting to them."}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"What organization the peer belongs to"}),"\n",(0,n.jsx)(t.li,{children:"What type of application the peer is"}),"\n",(0,n.jsx)(t.li,{children:"The application's unique identifier"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Controller certificates use SPIFFE IDs to allow the controllers to identify each during mTLS negotiation."}),"\n",(0,n.jsxs)(t.p,{children:["See ",(0,n.jsx)(t.a,{href:"https://spiffe.io/docs/latest/spiffe-about/spiffe-concepts/#spiffe-id",children:"SPIFFE IDs"})," for more information."]}),"\n",(0,n.jsx)(t.h3,{id:"trust-domain",children:"Trust domain"}),"\n",(0,n.jsxs)(t.p,{children:["A ",(0,n.jsx)(t.a,{href:"https://spiffe.io/docs/latest/spiffe-about/spiffe-concepts/#trust-domain",children:"trust domain"}),"\nis the part of a SPIFFE ID that indicates the organization that an identity belongs to."]}),"\n",(0,n.jsx)(t.h2,{id:"requirements",children:"Requirements"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"The certificates must have a shared root of trust"}),"\n",(0,n.jsx)(t.li,{children:"The controller client and server certificates must contain a SPIFFE ID."}),"\n",(0,n.jsx)(t.li,{children:"The controller client certificate's Common Name must exactly match the controller ID part of the SPIFFE ID."}),"\n",(0,n.jsxs)(t.li,{children:["The SPIFFE ID must be set as the only URI in the ",(0,n.jsx)(t.code,{children:"X509v3 Subject Alternative Name"})," field in the\ncertificate."]}),"\n",(0,n.jsxs)(t.li,{children:["The SPIFFE ID must have the following format: ",(0,n.jsx)(t.code,{children:"spiffe://<trust domain>/controller/<controller id>"})]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["So if the trust domain is ",(0,n.jsx)(t.code,{children:"ziti.example.com"})," and the controller id is ",(0,n.jsx)(t.code,{children:"ctrl1"}),", then the SPIFFE id\nwould be:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"spiffe://ziti.example.com/controller/ctrl1\n"})}),"\n",(0,n.jsx)(t.h2,{id:"steps-to-certificate-creation",children:"Steps to Certificate Creation"}),"\n",(0,n.jsx)(t.p,{children:"There are many ways to set up certificates, so this will just cover an example configuration."}),"\n",(0,n.jsx)(t.p,{children:"The primary thing to ensure is that controllers have a shared root of trust.\nOne way of generating certs would be as follows:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Create a root CA"}),"\n",(0,n.jsx)(t.li,{children:"Create an intermediate CA for each controller"}),"\n",(0,n.jsx)(t.li,{children:"Issue a server cert using the intermediate CA for each controller"}),"\n",(0,n.jsx)(t.li,{children:"Issue a client cert using the intermediate CA for each controller"}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"example",children:"Example"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["The OpenZiti CLI supports creating SPIFFE IDs in certificates","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Use the ",(0,n.jsx)(t.code,{children:"--trust-domain"})," flag when creating CAs"]}),"\n",(0,n.jsxs)(t.li,{children:["Use the ",(0,n.jsx)(t.code,{children:"--spiffe-id"})," flag when creating server or client certificates"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Using the OpenZiti PKI tool, certificates for a three node cluster could be created as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"# Create the trust root, a self-signed CA\nziti pki create ca --trust-domain ha.test --pki-root ./pki --ca-file ca --ca-name 'HA Example Trust Root'\n\n# Create the controller 1 intermediate/signing cert\nziti pki create intermediate --pki-root ./pki --ca-name ca --intermediate-file ctrl1 --intermediate-name 'Controller One Signing Cert'\n\n# Create the controller 1 server cert\nziti pki create server --pki-root ./pki --ca-name ctrl1 --dns \"localhost,ctrl1.ziti.example.com\" --ip \"127.0.0.1,::1\" --server-name ctrl1 --spiffe-id 'controller/ctrl1'\n\n# Create the controller 1 server cert\nziti pki create client --pki-root ./pki --ca-name ctrl1 --client-name ctrl1 --spiffe-id 'controller/ctrl1'\n\n# Create the controller 2 intermediate/signing cert\nziti pki create intermediate --pki-root ./pki --ca-name ca --intermediate-file ctrl2 --intermediate-name 'Controller Two Signing Cert'\n\n# Create the controller 2 server cert\nziti pki create server --pki-root ./pki --ca-name ctrl2 --dns \"localhost,ctrl2.ziti.example.com\" --ip \"127.0.0.1,::1\" --server-name ctrl2 --spiffe-id 'controller/ctrl2'\n\n# Create the controller 2 client cert\nziti pki create client --pki-root ./pki --ca-name ctrl2 --client-name ctrl2 --spiffe-id 'controller/ctrl2'\n\n# Create the controller 3 intermediate/signing cert\nziti pki create intermediate --pki-root ./pki --ca-name ca --intermediate-file ctrl3 --intermediate-name 'Controller Three Signing Cert'\n\n# Create the controller 3 server cert\nziti pki create server --pki-root ./pki --ca-name ctrl3 --dns \"localhost,ctrl3.ziti.example.com\" --ip \"127.0.0.1,::1\" --server-name ctrl3 --spiffe-id 'controller/ctrl3'\n\n# Create the controller 3 client cert\nziti pki create client --pki-root ./pki --ca-name ctrl3 --client-name ctrl3 --spiffe-id 'controller/ctrl3'\n"})})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},28453:(e,t,i)=>{i.d(t,{R:()=>c,x:()=>s});var r=i(96540);const n={},o=r.createContext(n);function c(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:c(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);