"use strict";(self.webpackChunkdocusaurus_3=self.webpackChunkdocusaurus_3||[]).push([[6995],{13121:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"learn/core-concepts/metrics/prometheus","title":"Prometheus Endpoint","description":"The controller can expose a /metrics endpoint that serves network metrics in the Prometheus text exposition format.","source":"@site/docs/learn/core-concepts/metrics/40-prometheus.md","sourceDirName":"learn/core-concepts/metrics","slug":"/learn/core-concepts/metrics/prometheus","permalink":"/docs/learn/core-concepts/metrics/prometheus","draft":false,"unlisted":false,"editUrl":"https://github.com/openziti/ziti-doc/tree/main/docusaurus/docs/learn/core-concepts/metrics/40-prometheus.md","tags":[],"version":"current","lastUpdatedAt":1743105452000,"sidebarPosition":40,"frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"On Demand","permalink":"/docs/learn/core-concepts/metrics/inspect"},"next":{"title":"Using Grafana","permalink":"/docs/learn/core-concepts/metrics/grafana"}}');var s=t(74848),r=t(28453);const o={},c="Prometheus Endpoint",a={},l=[{value:"Ziti Configuration",id:"ziti-configuration",level:2},{value:"Binding",id:"binding",level:3},{value:"Listener Just for Metrics",id:"listener-just-for-metrics",level:4},{value:"Add Metrics API to an Existing Listener",id:"add-metrics-api-to-an-existing-listener",level:4},{value:"Authentication",id:"authentication",level:3},{value:"Timestamps",id:"timestamps",level:3},{value:"Prometheus Configuration",id:"prometheus-configuration",level:3},{value:"TLS Configuration",id:"tls-configuration",level:4},{value:"With Authentication",id:"with-authentication",level:4},{value:"Examples",id:"examples",level:2},{value:"Setup Metrics Authentication",id:"setup-metrics-authentication",level:3},{value:"Create a cert for metric scraping",id:"create-a-cert-for-metric-scraping",level:4},{value:"Add the Cert to Ziti",id:"add-the-cert-to-ziti",level:4},{value:"Test the Key",id:"test-the-key",level:4},{value:"Add the Key to Prometheus",id:"add-the-key-to-prometheus",level:4}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"prometheus-endpoint",children:"Prometheus Endpoint"})}),"\n",(0,s.jsxs)(n.p,{children:["The controller can expose a ",(0,s.jsx)(n.code,{children:"/metrics"})," endpoint that serves network metrics in the Prometheus ",(0,s.jsx)(n.a,{href:"https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format",children:"text exposition format"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"The endpoint is exposed over HTTPS, and has optional support for client authentication via a certificate."}),"\n",(0,s.jsx)(n.h2,{id:"ziti-configuration",children:"Ziti Configuration"}),"\n",(0,s.jsx)(n.p,{children:"The Prometheus metric binding is configured as part of the controller configuration file."}),"\n",(0,s.jsx)(n.h3,{id:"binding",children:"Binding"}),"\n",(0,s.jsx)(n.p,{children:"The Prometheus metrics api is not bound to any interface by default. The metrics api can be bound to the same network interface and port as the other Ziti APIs, or it can be set up on its own interface and/or port."}),"\n",(0,s.jsx)(n.h4,{id:"listener-just-for-metrics",children:"Listener Just for Metrics"}),"\n",(0,s.jsxs)(n.p,{children:["The metric api can be configured to listen on its own combination of network interface and port by adding a new section under the ",(0,s.jsx)(n.code,{children:"web"})," configuration"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"web\n  # Binding for other Ziti APIs\n  - name: apis\n    bindPoints:\n      - interface: 0.0.0.0:1280\n        address: 0.0.0.0:1280\n    options:\n      idleTimeout: 5000ms  #http timeouts, new\n      readTimeout: 5000ms\n      writeTimeout: 100000ms\n    apis:\n      # binding - required\n      # Specifies an API to bind to this webListener. Built-in APIs are\n      #   - health-checks\n      #   - edge-management\n      #   - edge-client\n      #   - fabric-management\n      #   - metrics\n      - binding: health-checks\n        options: { }\n      - binding: fabric\n      - binding: edge-management\n        # options - variable optional/required\n        # This section is used to define values that are specified by the API they are associated with.\n        # These settings are per API. The example below is for the `edge-api` and contains both optional values and\n        # required values.\n        options: { }\n      - binding: edge-client\n        options: { }\n\n  # New binding for metrics\n  - name: apis-metrics-localhost\n    bindPoints:\n      #interface - required\n      # A host:port string on which network interface to listen on. 0.0.0.0 will listen on all interfaces\n      - interface: 127.0.0.1:2112\n\n        # address - required\n        # The public address that external incoming requests will be able to resolve. Used in request processing and\n        # response content that requires full host:port/path addresses.\n        address: 127.0.0.1:2112\n    options:\n    apis:\n      - binding: metrics\n        options: { }\n"})}),"\n",(0,s.jsx)(n.h4,{id:"add-metrics-api-to-an-existing-listener",children:"Add Metrics API to an Existing Listener"}),"\n",(0,s.jsx)(n.p,{children:"The metrics binding can be added to an existing listener in the controller."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"web\n  -name: apis\n   bindpoints:\n   apis: \n      - binding: health-checks\n        options: { }\n      - binding: fabric\n      - binding: edge-management\n        options: { }\n      - binding: edge-client\n        options: { }\n      - binding: metrics\n        options: { }\n"})}),"\n",(0,s.jsx)(n.h3,{id:"authentication",children:"Authentication"}),"\n",(0,s.jsx)(n.p,{children:"Authentication is done by adding a client certificate to the metrics binding.  The metrics endpoint will return a 401 if this certificate is not presented by clients when they connect."}),"\n",(0,s.jsx)(n.p,{children:"The certificate is completely stand-alone - it does not need to be signed by Ziti."}),"\n",(0,s.jsx)(n.p,{children:"The configuration is added as an option in the metrics binding.  The file must be an x509 certificate."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'     - binding: metrics\n        options: {\n          scrapeCert: "/etc/prometheus/prom-client.crt"\n        }\n'})}),"\n",(0,s.jsx)(n.h3,{id:"timestamps",children:"Timestamps"}),"\n",(0,s.jsx)(n.p,{children:"OpenZiti can export timestamps in the Prometheus metrics. These timestamps can be helpful to align metrics with application logs if there is any clock skew across the OpenZiti network."}),"\n",(0,s.jsxs)(n.p,{children:["Timestamps are disabled by default, and can be enabled by setting a the ",(0,s.jsx)(n.code,{children:"includeTimestamps"})," option to ",(0,s.jsx)(n.code,{children:"true"})," in the metrics binding:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"web\n  -name: apis\n   bindpoints:\n   apis:\n      - binding: health-checks\n        options: { }\n      - binding: fabric\n      - binding: edge-management\n        options: { }\n      - binding: edge-client\n        options: { }\n      - binding: metrics\n        options: {\n          includeTimestamps: true\n        }\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Prometheus will silently discard metrics that are older than five minutes."})}),"\n",(0,s.jsx)(n.h3,{id:"prometheus-configuration",children:"Prometheus Configuration"}),"\n",(0,s.jsx)(n.h4,{id:"tls-configuration",children:"TLS Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"/metrics"})," api requires TLS configuration in Prometheus. The Prometheus scrape config must have the ziti web public key, or be configured to ignore private keys."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"  - job_name: ziti\n    scheme: https\n    metrics_path: /metrics\n    honor_labels: true\n    honor_timestamps: true\n    tls_config:\n      // Path to the cert file with the ziti public key\n      ca_file: /etc/prometheus/server.crt\n      // OR ignore the key \n      insecure_skip_verify: true\n    static_configs:\n      - targets:\n        - '127.0.0.1:2112'\n"})}),"\n",(0,s.jsx)(n.h4,{id:"with-authentication",children:"With Authentication"}),"\n",(0,s.jsx)(n.p,{children:"It's a good idea to have metrics protected by a certificate to prevent nefarious actors from pulling metrics about your network.  The Prometheus scrape configuration can be configured with a keystore for this purpose:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:" - job_name: ziti\n    scheme: https\n    metrics_path: /metrics\n    honor_labels: true\n    honor_timestamps: true\n    tls_config:\n      cert_file: /etc/prometheus/prom-client.crt\n      key_file: /etc/prometheus/prom-client.key\n      ca_file: /etc/prometheus/server.crt\n    static_configs:\n      - targets:\n        - '127.0.0.1:2112'\n\n"})}),"\n",(0,s.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,s.jsx)(n.h3,{id:"setup-metrics-authentication",children:"Setup Metrics Authentication"}),"\n",(0,s.jsx)(n.p,{children:"In this example you will:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create a new cert and signing request"}),"\n",(0,s.jsx)(n.li,{children:"Sign the key"}),"\n",(0,s.jsx)(n.li,{children:"Add the key into your controller configuration"}),"\n",(0,s.jsx)(n.li,{children:"Add the key to your prometheus scrape config"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"create-a-cert-for-metric-scraping",children:"Create a cert for metric scraping"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"# Create the certificate and signing request\nopenssl req  -new  -newkey rsa:2048  -nodes  -keyout prom-client.key  -out prom-client.csr\n\n# Process the cert signing signing request.  This cert will be good for 10 years.\nopenssl  x509  -req  -days 3650 -in /tmp/prom-client.csr  -signkey prom-client.key  -out prom-client.crt \n"})}),"\n",(0,s.jsx)(n.h4,{id:"add-the-cert-to-ziti",children:"Add the Cert to Ziti"}),"\n",(0,s.jsxs)(n.p,{children:["Open your ziti configuration file and set up the metrics api binding as shown in the ",(0,s.jsx)(n.code,{children:"Authentication"})," section above."]}),"\n",(0,s.jsx)(n.p,{children:"Some common things to watch out for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The controller will need to be restarted after editing the configuration file"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Best practices is to use a separate metrics listener that is only accessible from Prometheus.  This configuration will expose the ",(0,s.jsx)(n.code,{children:"metrics/"})," on the loopback address, port 2112."]}),"\n",(0,s.jsxs)(n.p,{children:["Add this text to the ",(0,s.jsx)(n.code,{children:"web"})," section of your network controller configuration file"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'  - name: metrics-localhost\n    bindPoints:\n      - interface: 127.0.0.1:2112\n        address: 127.0.0.1:2112\n    apis:\n      - binding: metrics\n        options: {\n          scrapeCert: "/path/to/prom-client.crt"\n        }\n\n'})}),"\n",(0,s.jsx)(n.h4,{id:"test-the-key",children:"Test the Key"}),"\n",(0,s.jsxs)(n.p,{children:["I use ",(0,s.jsx)(n.code,{children:"curl"})," to test my keys when I set up metrics.  If Ziti is configured to bind metrics to ",(0,s.jsx)(n.code,{children:"127.0.0.1:2112"})," then curl command will be:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"curl -i -k --cert /path/to/prom-client.crt --key /path/to/prom-client.key https://127.0.0.1:2112/metrics\n"})}),"\n",(0,s.jsx)(n.p,{children:"The options to the curl command mean:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"-i:"})," Print the http status code and response headers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"-k:"})," Ziti uses a self-signed cert, this option tells curl to ignore the server certificate"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"--cert:"})," The path to the prom-client.crt created above"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"--key:"})," The path to prom-client.key created above"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The result should spit out a bunch of metrics.   If you see a ",(0,s.jsx)(n.code,{children:"401"})," response then double-check that you've copied all of the bits from the certificate into the controller configuration file."]}),"\n",(0,s.jsx)(n.h4,{id:"add-the-key-to-prometheus",children:"Add the Key to Prometheus"}),"\n",(0,s.jsx)(n.p,{children:"The key is added to Prometheus by referencing the crt and key files from the Ziti scrape configuration."}),"\n",(0,s.jsx)(n.p,{children:"Your scrape config will look something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"global:\n  scrape_interval: 10s\n  scrape_timeout: 10s\n\nrule_files:\n  - alert.yml\n\nscrape_configs:\n  - job_name: self\n    metrics_path: /metrics\n    static_configs:\n      - targets:\n        - 'prometheus:9090'\n\n  - job_name: ziti\n    scheme: https\n    metrics_path: /metrics\n    honor_labels: true # Ziti supplies system labels for the edge routers, so we need to obey them\n    honor_timestamps: true # Honor server timestamps instead of using the scrape timestamp for metrics\n    tls_config:\n      cert_file: /path/to/prom-client.crt\n      key_file: /path/to/prom-client.key\n      insecure_skip_verify: true\n    static_configs:\n      - targets:\n        - '127.0.0.1:2112'\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var i=t(96540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);