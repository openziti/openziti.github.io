"use strict";(self.webpackChunkdocusaurus_3=self.webpackChunkdocusaurus_3||[]).push([[58900],{19839:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var o=n(49443),i=n(74848),s=n(28453);const r={title:"Private DNS on Windows",seoTitle:"Private DNS on Windows using OpenZiti",seoDescription:"A short article that discusses how the Ziti Desktop Edge for Windows from the OpenZiti project provides secure, authenticated DNS for users.",date:new Date("2023-03-15T21:06:11.000Z"),cuid:"clfa69o4m000509lbe5qagw7h",slug:"private-dns-on-windows",authors:["ClintDovholuk"],image:"@site/blogs/openziti/v1678971944159/0a3cfe23-5f9a-4576-a89d-e272b3b360d4.png",imageDark:"@site/blogs/openziti/v1678971944159/0a3cfe23-5f9a-4576-a89d-e272b3b360d4.png",tags:["dns","security","windows","openziti","nrpt"]},a=void 0,l={authorsImageUrls:[void 0]},d=[{value:"How Private DNS works on Windows",id:"how-private-dns-works-on-windows",level:2},{value:"What is the NRPT",id:"what-is-the-nrpt",level:2},{value:"An Example - RDP&#39;ing to Mom&#39;s Computer",id:"an-example---rdping-to-moms-computer",level:3},{value:"Using the NRPT",id:"using-the-nrpt",level:2},{value:"Local Nameserver",id:"local-nameserver",level:3}];function h(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["OpenZiti's tunnelers have a killer feature, ",(0,i.jsx)(t.a,{href:"https://www.youtube.com/playlist?list=PLMUj_5fklasKF1oisSSuLwSzLVxuL9JbC",children:"a superpower"}),', if you will: "Private" DNS. "Private DNS," I hear you ask with a subtle tone of disbelief, "what does ',(0,i.jsx)(t.em,{children:"that"}),' mean?" When you have an OpenZiti tunneler running on your system with one or more enrolled ',(0,i.jsx)(t.a,{href:"https://netfoundry.io/docs/openziti/learn/core-concepts/identities/overview/",children:"identities"}),", it's likely those ",(0,i.jsx)(t.a,{href:"https://netfoundry.io/docs/openziti/learn/core-concepts/services/overview/",children:"services"}),' have "intercepts" configured. Those intercepts are often in the form of some DNS entry and those DNS entries are only available to your system when OpenZiti is running. ',(0,i.jsx)(t.strong,{children:"That"}),", is what it means to have \"Private DNS\". These private DNS entries are valuable because they are only available to people who are authenticated and authorized to have them. If you're not authorized, you won't see the entry at all. That's very cool!"]}),"\n",(0,i.jsx)(t.h2,{id:"how-private-dns-works-on-windows",children:"How Private DNS works on Windows"}),"\n",(0,i.jsx)(t.p,{children:"Capturing DNS requests is somewhat tricky, as you might expect. Compounding the problem, each operating system works differently. To make matters worse, DNS is such a fundamental part of your (or your users') operating system, when you get it wrong, it's very disruptive! When DNS isn't working, it seems like your whole network doesn't work! (Depicted is Ziggy wondering why his network doesn't work because DNS is broken)"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://raw.githubusercontent.com/openziti/branding/main/images/ziggy/png/Ziggy-has-a-Question-Closeup.png",alt:""})}),"\n",(0,i.jsxs)(t.p,{children:["So how does OpenZiti accomplish intercepting any DNS entry at all, including overriding existing DNS entries? We first tried to use the API provided by Microsoft for creating a VPN. That API was poorly documented, difficult to implement and didn't do exactly what we wanted. We had to find a better way, and we did! On the Windows operating system, we were able to successfully use a feature called the ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn593632(v=ws.11)",children:"Name Resolution Policy Table, or NRPT for short"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"what-is-the-nrpt",children:"What is the NRPT"}),"\n",(0,i.jsx)(t.p,{children:"The NRPT is really neat. Through the NRPT, we can provide instructions to the operating system to send DNS requests matching a particular pattern to a particular nameserver. That is exactly what we need! If that's not clear enough, let's look at an example."}),"\n",(0,i.jsx)(t.h3,{id:"an-example---rdping-to-moms-computer",children:"An Example - RDP'ing to Mom's Computer"}),"\n",(0,i.jsxs)(t.p,{children:["Last year I needed to do some remote work on my mother's computer. Instead of using one of the existing remote desktop solutions out there, I used OpenZiti. I didn't feel like trying to get my mother to download and install the ",(0,i.jsx)(t.strong,{children:"correct"})," app, the correct version, etc. I was able to send her an email with the exact link to install and a one-use token to use. Here's what I wanted to do:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:n(6381).A+"",width:"1190",height:"484"})}),"\n",(0,i.jsx)(t.p,{children:'Once enrolled, her RDP service (and only her RDP service) was available to me via my OpenZiti overlay network. I defined a single service so I could use RDP to remote into her machine. To make it easy for me to remember, I defined a private DNS entry called "mom.rdp", I authorized my identity to dial and hers to host and then I was able to RDP to mom.rdp!'}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:n(6124).A+"",width:"410",height:"258"})}),"\n",(0,i.jsx)(t.p,{children:'In this example, I need my operating system to be able to resolve "mom.rdp" to an IP address so that my computer knows how to send data across the OpenZiti overlay.'}),"\n",(0,i.jsx)(t.h2,{id:"using-the-nrpt",children:"Using the NRPT"}),"\n",(0,i.jsxs)(t.p,{children:['For Windows to be able to resolve "mom.rdp", a few things need to happen. As mentioned, we need an identity that has been enrolled with the ',(0,i.jsx)(t.a,{href:"https://github.com/openziti/desktop-edge-win/releases/latest",children:"Ziti Desktop Edge for Windows (ZDEW)"}),'. The identity also needs to have access (been authorized) to a service with an intercept configured for "mom.rdp". Once authorized, when the ZDEW notices it has a new service, it will run a ',(0,i.jsx)(t.a,{href:"https://github.com/openziti/ziti-tunnel-sdk-c/blob/ecc12ff3feaf2c0547928bcbe1880192bd0b4da3/programs/ziti-edge-tunnel/windows-scripts.c#L152",children:"powershell command"})," to add the entry to the NRPT using the commandlet named ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/powershell/module/dnsclient/add-dnsclientnrptrule?view=windowsserver2022-ps",children:"Add-DnsClientNrptRule"}),". Why a powershell command and not an API call? ",(0,i.jsx)(t.strong,{children:"GREAT QUESTION!"})," It's because Microsoft (at this time) does not provide one! Perhaps you can encourage Microsoft to provide an actual API people and projects like OpenZiti can invoke instead!"]}),"\n",(0,i.jsxs)(t.p,{children:["The NRPT rule does one specific thing. It instructs Windows that when you see a DNS request to a matching name, send it to this specific server. If you have a ZDEW running, you can see all your configured rules from the ZDEW by running ",(0,i.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/powershell/module/dnsclient/get-dnsclientnrptpolicy?view=windowsserver2022-ps",children:"Get-DnsClientNrptPolicy"})]}),"\n",(0,i.jsx)(t.p,{children:"Here's an edited snippet from my NRPT of the rule allowing me to RDP to my mother's computer:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-plaintext",children:"Namespace                        : mom.rdp\n...SNIP...\nNameServers                      : 100.64.0.2\n"})}),"\n",(0,i.jsxs)(t.p,{children:["You can see that one of my identities is providing a private DNS entry of mom.rdp, and it instructs Windows to send any requests matching the namespace to the ",(0,i.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Name_server",children:"nameserver"})," located at 100.64.0.2."]}),"\n",(0,i.jsx)(t.h3,{id:"local-nameserver",children:"Local Nameserver"}),"\n",(0,i.jsx)(t.p,{children:"The NRPT has told Windows to send any DNS request to 100.64.0.2 if it matches mom.rdp exactly, but something needs to answer the DNS query. OpenZiti tunnelers all run a built-in nameserver to satisfy these requests. You'll find the nameserver at whatever the start of private IP space is configured to be, \"plus 1\". By default, the ZDEW will create and configure a local network interface at 100.64.0.1, so by adding one to that IP, you'll have a nameserver on 100.64.0.2."}),"\n",(0,i.jsxs)(t.p,{children:["We can test this too. We can use the built-in ",(0,i.jsx)(t.code,{children:"nslookup"})," to make a query to the specific nameserver ",(0,i.jsx)(t.strong,{children:"or"})," we can use the PowerShell commandlet ",(0,i.jsx)(t.code,{children:"DnsClient-ResolveName"}),". It's important to note that DNS tooling sometimes specifically avoids things like the NRPT! For example, if you use ",(0,i.jsx)(t.code,{children:"nslookup"}),", ",(0,i.jsx)(t.strong,{children:"make sure"})," you provide the server to send the DNS request to. If you don't you might be surprised that it doesn't work!"]}),"\n",(0,i.jsxs)(t.p,{children:["Example of using ",(0,i.jsx)(t.code,{children:"nslookup mom.rdp 100.64.0.2"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-plaintext",children:"nslookup mom.rdp 100.64.0.2\nServer:  UnKnown\nAddress:  100.64.0.2\n\nNon-authoritative answer:\nName:    mom.rdp\nAddress:  100.64.0.6\n"})}),"\n",(0,i.jsxs)(t.p,{children:["and Powershell's ",(0,i.jsx)(t.code,{children:"Resolve-DnsName mom.rdpa"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-plaintext",children:"Resolve-DnsName mom.rdp\n\nName                                           Type   TTL   Section    IPAddress\n----                                           ----   ---   -------    ---------\nmom.rdp                                        A      60    Answer     100.64.0.6\n"})}),"\n",(0,i.jsx)(t.h1,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(t.p,{children:"That's basically it. The Ziti Desktop Edge for Windows is responsible for managing the NRPT. It manages it using Powershell commands because there are no APIs available yet for an application to manipulate the NRPT at this time. When new services show up, we map all the private DNS entries to NRPT rules and run a small nameserver from the ZDEW to properly answer the DNS requests."}),"\n",(0,i.jsx)(t.p,{children:"This technique is fairly well-known now, but when the ZDEW was first created back in late 2019, it wasn't quite as easy to discover. Maybe you've never heard or seen the NRPT and maybe you'll go check it out."})]})}function c(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},6124:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/e840fe62-290a-482d-a7e5-2597e1d47c94-8bcb04092184bfae5dcb1c0b88e49815.png"},6381:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/2f0dff3a-bf7c-463e-9bc4-bcbeb4bac89c-387c99143f620dbe98becd7cd0997733.png"},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var o=n(96540);const i={},s=o.createContext(i);function r(e){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:t},e.children)}},49443:e=>{e.exports=JSON.parse('{"permalink":"/docs/openziti/blog/private-dns-on-windows","source":"@site/blog/private-dns-on-windows.md","title":"Private DNS on Windows","description":"OpenZiti\'s tunnelers have a killer feature, a superpower, if you will: \\"Private\\" DNS. \\"Private DNS,\\" I hear you ask with a subtle tone of disbelief, \\"what does that mean?\\" When you have an OpenZiti tunneler running on your system with one or more enrolled identities, it\'s likely those services have \\"intercepts\\" configured. Those intercepts are often in the form of some DNS entry and those DNS entries are only available to your system when OpenZiti is running. That, is what it means to have \\"Private DNS\\". These private DNS entries are valuable because they are only available to people who are authenticated and authorized to have them. If you\'re not authorized, you won\'t see the entry at all. That\'s very cool!","date":"2023-03-15T21:06:11.000Z","tags":[{"inline":false,"label":"DNS","permalink":"/docs/openziti/blog/tags/dns","description":"DNS topics"},{"inline":false,"label":"Security","permalink":"/docs/openziti/blog/tags/security","description":"Security-related posts"},{"inline":false,"label":"Windows","permalink":"/docs/openziti/blog/tags/windows","description":"Windows topics"},{"inline":false,"label":"OpenZiti","permalink":"/docs/openziti/blog/tags/openziti","description":"OpenZiti related content"},{"inline":false,"label":"NRPT","permalink":"/docs/openziti/blog/tags/nrpt","description":"Windows NRPT"}],"readingTime":5.79,"hasTruncateMarker":true,"authors":[{"name":"Clint Dovholuk","title":"Author","url":"https://github.com/dovholuknf","imageURL":"https://avatars.githubusercontent.com/dovholuknf","key":"ClintDovholuk","page":null}],"frontMatter":{"title":"Private DNS on Windows","seoTitle":"Private DNS on Windows using OpenZiti","seoDescription":"A short article that discusses how the Ziti Desktop Edge for Windows from the OpenZiti project provides secure, authenticated DNS for users.","date":"2023-03-15T21:06:11.000Z","cuid":"clfa69o4m000509lbe5qagw7h","slug":"private-dns-on-windows","authors":["ClintDovholuk"],"image":"@site/blogs/openziti/v1678971944159/0a3cfe23-5f9a-4576-a89d-e272b3b360d4.png","imageDark":"@site/blogs/openziti/v1678971944159/0a3cfe23-5f9a-4576-a89d-e272b3b360d4.png","tags":["dns","security","windows","openziti","nrpt"]},"unlisted":false,"prevItem":{"title":"My Pi Day Journey with Go 64-bit alignment","permalink":"/docs/openziti/blog/my-pi-day-journey-with-go-64-bit-alignment"},"nextItem":{"title":"Websockets over zrok","permalink":"/docs/openziti/blog/websockets-over-zrok"}}')}}]);