"use strict";(self.webpackChunkdocusaurus_3=self.webpackChunkdocusaurus_3||[]).push([[4081],{7576:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"guides/deployments/linux/controller/backup","title":"Controller Backup and Recovery","description":"Backup","source":"@site/docs/guides/deployments/10-linux/10-controller/60-backup.mdx","sourceDirName":"guides/deployments/10-linux/10-controller","slug":"/guides/deployments/linux/controller/backup","permalink":"/docs/guides/deployments/linux/controller/backup","draft":false,"unlisted":false,"editUrl":"https://github.com/openziti/ziti-doc/tree/main/docusaurus/docs/guides/deployments/10-linux/10-controller/60-backup.mdx","tags":[],"version":"current","lastUpdatedAt":1757339600000,"sidebarPosition":60,"frontMatter":{"title":"Controller Backup and Recovery","sidebar_label":"Backup"},"sidebar":"docsSidebar","previous":{"title":"Migrate","permalink":"/docs/guides/deployments/linux/controller/migrate"},"next":{"title":"Router Deployment","permalink":"/docs/guides/deployments/linux/router/deploy"}}');var r=n(74848),o=n(28453);const a={title:"Controller Backup and Recovery",sidebar_label:"Backup"},s=void 0,l={},c=[{value:"Backup",id:"backup",level:2},{value:"Backing up the Configuration File",id:"backing-up-the-configuration-file",level:3},{value:"Backing up the PKI Files",id:"backing-up-the-pki-files",level:3},{value:"Backing up the Database",id:"backing-up-the-database",level:3},{value:"Recovery",id:"recovery",level:2},{value:"Recovering Configuration File",id:"recovering-configuration-file",level:3},{value:"Recovering PKI",id:"recovering-pki",level:3},{value:"Recovering the Database",id:"recovering-the-database",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h2,{id:"backup",children:"Backup"}),"\n",(0,r.jsx)(t.p,{children:"You can recover from the catastrophic loss of the controller if you back up the configuration file, root CA, and\ndatabase."}),"\n",(0,r.jsx)(t.p,{children:"The three stateful aspects of the controller are the configuration file, PKI, and the database. Ensure you back up all\nthe files mentioned in the controller's configuration file (keys, certs, root CA bundle, and the database), and the\nconfig YAML file itself."}),"\n",(0,r.jsxs)(t.p,{children:["If you're using the Linux service you may accomplish this by triggering the database snapshot operation and backing up\nthe ",(0,r.jsx)(t.strong,{children:"/var/lib/ziti-controller"})," directory."]}),"\n",(0,r.jsx)(t.h3,{id:"backing-up-the-configuration-file",children:"Backing up the Configuration File"}),"\n",(0,r.jsx)(t.p,{children:"The controller's configuration file is specified as a positional parameter when the controller is run. You can back\nup this file or provide any valid controller configuration file to recover."}),"\n",(0,r.jsx)(t.h3,{id:"backing-up-the-pki-files",children:"Backing up the PKI Files"}),"\n",(0,r.jsx)(t.p,{children:"It is crucial to back up the irreplaceable root CAs. You can ease disaster recovery by issuing all leaf certificates\nfrom an intermediate CA and securing the root CA on a different host. This ensures that the controller's PKI files are\nreplaceable. You can safely remove the root CA from the controller host after it is secured elsewhere, or you can begin\nwith the root CA on a different host and issue an intermediate CA for the first controller and any future replacement\ncontrollers."}),"\n",(0,r.jsx)(t.p,{children:"The controller issues leaf certificates during enrollment from its edge signer CA. If the edge signer is an\nintermediate, then it's unnecessary to back up the intermediate CA cert or private key because every part of the system\nis configured to trust the root. The controller's leaf certificate files must begin with the leaf and contain their\nintermediate issuer chain. This configures the controller to present the partial chain during the TLS handshake,\nallowing the other party to complete the chain with their copy of the root CA."}),"\n",(0,r.jsx)(t.p,{children:"The following configuration properties refer to PKI files that must be backed up if not using an intermediate CA."}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"identity"})," may appear in several places and always configures keys, leaf certs, and CA certs. When this property\nappears at the top level of the configuration file, its ",(0,r.jsx)(t.code,{children:"ca"})," property has a special meaning and configures a bundle of\nroot CAs that all parts of the network should trust."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"edge.enrollment.signingCert"})," always appears in one place and configures the controller's edge signer CA key and cert."]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"backing-up-the-database",children:"Backing up the Database"}),"\n",(0,r.jsxs)(t.p,{children:["The Controller uses a ",(0,r.jsx)(t.a,{href:"https://github.com/etcd-io/bbolt",children:"Bolt"})," database to store its state. You will use the database\nsnapshot to initialize the replacement controller during recovery."]}),"\n",(0,r.jsxs)(t.p,{children:["The database is a writable file in a path specified by the controller's configuration property ",(0,r.jsx)(t.code,{children:"db"})," (",(0,r.jsx)(t.a,{href:"/docs/reference/configuration/controller#db",children:"link to config\nreference"}),")."]}),"\n",(0,r.jsx)(t.p,{children:"Use the controller's built-in database snapshot operation to preserve data integrity. The snapshot operation creates a\nsnapshot file in the same filesystem directory as the main database file on the controller host, so you can periodically\nback up the directory containing the configuration file and database and snapshots."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-text",children:"ziti edge db snapshot\n"})}),"\n",(0,r.jsx)(t.h2,{id:"recovery",children:"Recovery"}),"\n",(0,r.jsx)(t.p,{children:"In a scenario where the controller's state was lost, you can recover by restoring the configuration file, PKI, and\ndatabase snapshot."}),"\n",(0,r.jsx)(t.h3,{id:"recovering-configuration-file",children:"Recovering Configuration File"}),"\n",(0,r.jsxs)(t.p,{children:["The path to the configuration file is a controller run parameter. You can restore the same configuration file or\nprovide any valid controller configuration. It's not necessary to use the same filesystem paths on the new host, but the\nconfiguration file must be edited to reflect the new paths if they change. You may use environment variables within the\nconfiguration file for paths within the ",(0,r.jsx)(t.code,{children:"db"})," and any ",(0,r.jsx)(t.code,{children:"identity"})," blocks."]}),"\n",(0,r.jsx)(t.h3,{id:"recovering-pki",children:"Recovering PKI"}),"\n",(0,r.jsxs)(t.p,{children:["The controller's configuration file contains URIs for its private keys, leaf certificates, edge signer CA\ncertificate, and trust bundle. If the URI scheme is not specified it is interpreted as a ",(0,r.jsx)(t.code,{children:"file://"})," URI, which may be\nrelative to the directory where the configuration file is located or absolute."]}),"\n",(0,r.jsxs)(t.p,{children:["You can restore these files from a backup, or, if using intermediate CA(s), you can instead generate new keys, issue a\nnew intermediate CA cert from the same root CA, and issue new leaf certificates from the new intermediate CA (",(0,r.jsx)(t.a,{href:"/docs/guides/troubleshooting/pki-troubleshooting/renew-cert",children:"link to certificate renewal guide"}),")."]}),"\n",(0,r.jsx)(t.h2,{id:"recovering-the-database",children:"Recovering the Database"}),"\n",(0,r.jsx)(t.p,{children:"If the controller was lost then a new controller can be initialized with a database snapshot."}),"\n",(0,r.jsx)(t.p,{children:"If you backed up the directory containing the active database and snapshots, ensure you restore the latest snapshot to\npreserve data integrity. The backed-up active database file may not be internally consistent."})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>s});var i=n(96540);const r={},o=i.createContext(r);function a(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);